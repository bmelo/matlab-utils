<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of bruno_percent_signal_change</title>
  <meta name="keywords" content="bruno_percent_signal_change">
  <meta name="description" content="Extraction of Percent signal change using marsbar and SPM8: BATCH.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # components --><!-- ../menu.html +neuro --><!-- menu.html +marsbar -->
<h1>bruno_percent_signal_change
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Extraction of Percent signal change using marsbar and SPM8: BATCH.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>This is a script file. </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Extraction of Percent signal change using marsbar and SPM8: BATCH.
 The file structures are in this script are in Mac OS X format.
 PC users should find all the '/' in the script and replace with '\'.
 Also make sure your directory works in MATLAB as '/Volumes/Disk/Data'
 works on Mac where as 'C:\Data\' is a typical PC configuration.
 This script assumes you have a first level fMRI design which has been
 estimated in SPM, and has a set of contrasts specified.
 This script assumes your design is stored in /my/path/SPM.mat and you
 have an ROI stored in /my/path/my_roi.mat.
 The only four things you will hopefully need to change are:
 (1) the data root directory (a folder that contains all the participant subfolders);
 (2) the names of the participant subfolders; and,
 (3) the ROI you have created in marsbar.
 (4) the file name and type to which you want your percent signal change values to be saved.
 These are indicated below. See (5) if the script doesn't use all the
 contrasts available.
 The output file is saved as a single row and is comma delimited,
 so all you need to do is delete the first item (the title) that is delimited by a comma,
 insert a return before each of the 'sub' IDs (participant subfolders) so that each
 participants' data is on a new row, and then save the file.
 The final step is to import the data into Excel. File &gt; Import... &gt; Text
 file &gt; Choose your file &gt; Delimited Start import at row 1 &gt; Delimiters
 tick comma &gt; Finish &gt; OK. The first column should be the participant subfolder
 and the last column should be '/n'. As Excel may find the values with minus signs
 as a formula, just Find All '=' and replace with nothing, and while you are at it
 do the '/n' as well.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <span class="comment">% Extraction of Percent signal change using marsbar and SPM8: BATCH.</span>
0002 <span class="comment">% The file structures are in this script are in Mac OS X format.</span>
0003 <span class="comment">% PC users should find all the '/' in the script and replace with '\'.</span>
0004 <span class="comment">% Also make sure your directory works in MATLAB as '/Volumes/Disk/Data'</span>
0005 <span class="comment">% works on Mac where as 'C:\Data\' is a typical PC configuration.</span>
0006 <span class="comment">% This script assumes you have a first level fMRI design which has been</span>
0007 <span class="comment">% estimated in SPM, and has a set of contrasts specified.</span>
0008 <span class="comment">% This script assumes your design is stored in /my/path/SPM.mat and you</span>
0009 <span class="comment">% have an ROI stored in /my/path/my_roi.mat.</span>
0010 <span class="comment">% The only four things you will hopefully need to change are:</span>
0011 <span class="comment">% (1) the data root directory (a folder that contains all the participant subfolders);</span>
0012 <span class="comment">% (2) the names of the participant subfolders; and,</span>
0013 <span class="comment">% (3) the ROI you have created in marsbar.</span>
0014 <span class="comment">% (4) the file name and type to which you want your percent signal change values to be saved.</span>
0015 <span class="comment">% These are indicated below. See (5) if the script doesn't use all the</span>
0016 <span class="comment">% contrasts available.</span>
0017 <span class="comment">% The output file is saved as a single row and is comma delimited,</span>
0018 <span class="comment">% so all you need to do is delete the first item (the title) that is delimited by a comma,</span>
0019 <span class="comment">% insert a return before each of the 'sub' IDs (participant subfolders) so that each</span>
0020 <span class="comment">% participants' data is on a new row, and then save the file.</span>
0021 <span class="comment">% The final step is to import the data into Excel. File &gt; Import... &gt; Text</span>
0022 <span class="comment">% file &gt; Choose your file &gt; Delimited Start import at row 1 &gt; Delimiters</span>
0023 <span class="comment">% tick comma &gt; Finish &gt; OK. The first column should be the participant subfolder</span>
0024 <span class="comment">% and the last column should be '/n'. As Excel may find the values with minus signs</span>
0025 <span class="comment">% as a formula, just Find All '=' and replace with nothing, and while you are at it</span>
0026 <span class="comment">% do the '/n' as well.</span>
0027 
0028 <span class="comment">%(1) Directories:</span>
0029 curdir = pwd;
0030 data_dir = <span class="string">'/dados1/PROJETOS/PRJ1410_FUTEBOL/03_PROCS/PROC_DATA/fMRI/NORM_ANAT/STATS/FIRST_LEVEL/RESP_MOV_EFFORT_SEP_CSO'</span>;
0031 rois_dir = <span class="string">'/dados1/PROJETOS/PRJ1410_FUTEBOL/03_PROCS/ROIs/'</span>;
0032 out_dir  = pwd;
0033 
0034 <span class="comment">%(2) the names of the participant subfolders</span>
0035 subjs = [2:16 18:26 28];
0036 nsub = length(subjs);
0037 
0038 <span class="comment">%(3) the ROI you have created in marsbar. You can put multiple ROIs in</span>
0039 <span class="comment">%here, but I thought it was easier to put in one at a time as the output is</span>
0040 <span class="comment">%messy as is.</span>
0041 roi_files = {<span class="string">'Occipital_9_-85_-7_roi'</span>};
0042 n_roi = size (roi_files,1);
0043 pcs_data = zeros(length(subjs),1);
0044 
0045 spm(<span class="string">'Defaults'</span>, <span class="string">'fmri'</span>)
0046 
0047 <span class="comment">% global defaults</span>
0048 <span class="keyword">for</span> n = 1: n_roi
0049     fprintf( <span class="string">'loading ROI %s\n'</span>, roi_files{n} );
0050     roi_file = fullfile( rois_dir, roi_files{n} );
0051     load( roi_file );
0052     
0053     <span class="comment">% pcs_data = [];</span>
0054     <span class="keyword">for</span> k = 1:length(subjs)
0055         subjid = sprintf(<span class="string">'SUBJ%03d'</span>, subjs(k));
0056         subdir = fullfile( data_dir, subjid );
0057         sprintf(<span class="string">'Working on participant %s\n'</span>,subdir)
0058         cd(subdir);
0059         load SPM;
0060         <span class="comment">% Make marsbar design object</span>
0061         D = mardo(SPM);
0062         <span class="comment">% Make marsbar ROI object</span>
0063         R = maroi( roi_file );
0064         <span class="comment">% Fetch data into marsbar data object</span>
0065         Y = get_marsy(R, D, <span class="string">'mean'</span>);
0066         <span class="comment">% Get contrasts from original design</span>
0067         xCon = get_contrasts(D);
0068         <span class="comment">% Estimate design on ROI data</span>
0069         E = estimate(D, Y);
0070         <span class="comment">% Put contrasts from original design back into design object</span>
0071         E = set_contrasts(E, xCon);
0072         <span class="comment">% get design betas</span>
0073         <span class="comment">% b = betas(E);</span>
0074         <span class="comment">% get stats and stuff for all contrasts into statistics structure</span>
0075         <span class="comment">% (5) I edited this so stop at the basic contrasts for the events</span>
0076         <span class="comment">% as the script didn't work for me with my design otherwise.</span>
0077         <span class="comment">% The original script had: marsS = compute_contrasts(E, 1:length(xCon));</span>
0078         marsS = compute_contrasts(E, 1:4);
0079         <span class="comment">% Get definitions of all events in model</span>
0080         [e_specs, e_names] = event_specs(E);
0081         n_events = size(e_specs, 2);
0082         dur = 0;
0083         pct_ev = [];
0084         <span class="comment">% Return percent signal esimate for all events in design</span>
0085         <span class="keyword">for</span> e_s = 1:n_events
0086             pct_ev(e_s) = event_signal(E, e_specs(:,e_s), dur);
0087         <span class="keyword">end</span>
0088         <span class="comment">%Aloca memoria para as matrizes</span>
0089         <span class="keyword">if</span>( k==1 )
0090             pcs_data = zeros(length(subjs), n_events);
0091             nEvtS = max(e_specs(2,:)); <span class="comment">%number of events per session</span>
0092             pcs_data_mean = zeros(length(subjs), nEvtS);
0093         <span class="keyword">end</span>
0094         pcs_data(k,:) = pct_ev;
0095         pcs_data_mean(k,:) = mean( reshape( pct_ev, nEvtS, [] )' );
0096     <span class="keyword">end</span>
0097     
0098     regname=char(SPM.xX.name(1,:));
0099 
0100     <span class="comment">% (4) the file name (e.g., ROI co-ords) and type (e.g., .txt, .csv, .xls) to which you want your</span>
0101     <span class="comment">% percent signal change values to be saved.</span>
0102     <span class="comment">% regname = char (e_names);</span>
0103     fvolumes = fopen( fullfile(out_dir, [<span class="string">'out_PSC'</span> datestr(now, <span class="string">'yyyymmdd_HHMM'</span>) <span class="string">'.txt'</span>]), <span class="string">'w'</span>);
0104     fprintf( fvolumes, <span class="string">'ROI =\t%s\n\n'</span>, roi_files{n} );
0105     fprintf( fvolumes, <span class="string">'SUBJ x Eventos\t'</span> );
0106     <span class="keyword">for</span> nname=1:n_events
0107         nS = e_specs(1,nname);<span class="comment">%numero da sessao</span>
0108         fprintf(fvolumes, <span class="string">'%s (%d)\t'</span>,e_names{nname}, nS);
0109     <span class="keyword">end</span>
0110     
0111     <span class="keyword">for</span> nsub=1:length(subjs)
0112         subjid = sprintf(<span class="string">'SUBJ%03d'</span>, nsub);
0113         fprintf( fvolumes, <span class="string">'\n%s\t'</span>, subjid );
0114         fprintf( fvolumes, <span class="string">'%.4f\t%.4f\t%.4f\t%.4f\t%.4f\t%.4f\t'</span>, pcs_data(nsub,:));
0115     <span class="keyword">end</span>;
0116     
0117     <span class="comment">%Valores com as médias.</span>
0118     fprintf( fvolumes, <span class="string">'\n\nMÉDIAS\n'</span> );
0119     fprintf( fvolumes, <span class="string">'SUBJ x Eventos\t'</span> );
0120     <span class="keyword">for</span> nname=1:n_events
0121         nS = e_specs(1,nname);<span class="comment">%numero da sessao</span>
0122         <span class="keyword">if</span> ( nS &gt; 1 ); <span class="keyword">break</span>; <span class="keyword">end</span>;
0123         fprintf(fvolumes, <span class="string">'%s\t'</span>,e_names{nname});
0124     <span class="keyword">end</span>
0125     
0126     <span class="keyword">for</span> nsub=1:length( subjs )
0127         subjid = sprintf(<span class="string">'SUBJ%03d'</span>, nsub);
0128         fprintf( fvolumes, <span class="string">'\n%s\t'</span>, subjid );
0129         fprintf( fvolumes, <span class="string">'%.4f\t%.4f\t%.4f\t%.4f\t%.4f\t%.4f\t'</span>, pcs_data_mean(nsub,:));
0130     <span class="keyword">end</span>;
0131     
0132     fclose(<span class="string">'all'</span>);
0133 <span class="keyword">end</span>
0134 cd(curdir);</pre></div>
<hr><address>Generated on Thu 23-Feb-2017 17:54:44 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>