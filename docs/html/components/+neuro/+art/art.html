<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of art</title>
  <meta name="keywords" content="art">
  <meta name="description" content="art - module for automatic and manual detection and removal of outliers.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # components --><!-- ../menu.html +neuro --><!-- menu.html +art -->
<h1>art
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>art - module for automatic and manual detection and removal of outliers.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function varargout = art_IDOR(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> art - module for automatic and manual detection and removal of outliers.

 art
 Lauches the art GUI. This will prompt the user to enter the functional
 volumes and motion pararameters (SPM, FSL, or Siemens supported) for one
 subject (one or multiple sessions). It then displays four graphs:

 The top graph is the global brain activation mean as a function of
 time, with all of the identified outlier scans marked. Optionally it also
 overlais the task-related regressors (SPM designs only) and break down of
 number of identified outliers per condition. 

 The second graph shows the timeseries derived from the global BOLD signal
 and used to identify potential outlier scans (either absolute or
 scan-to-scan differences in the global BOLD signal normalized to
 z-scores) 

 The third graph shows the timeseries derived from the subject motion
 parameters and used to identify potential outlier scans (either the
 absolute or scan-to-scan differences in the individual motion parameters
 -x,y,z translation parameters and roll,pitch,yaw rotation parameters-, or
 the absolute or scan-to-scan differences in a single 'composite motion'
 measure -maximal movement of any voxel within the brain bounding box-)

 Using default threshold values for each of the bottom three graphs
 we define outliers as points that exceed the threshold in at least
 one of the global signal or motion parameter graphs. The thresholds are
 shown as horizontal black lines in each of the graphs.

 Points which are identified as outliers, are indicated by a vertical
 black line in the graph that corresponds to the outlying
 parameter(s). For example, the if the absolute value of the Y motion
 parameter for time t=17 is above the motion threshold, it is
 identified as an outlier and indicated by a black vertical line at
 t=17 in the third graph. The union of all outliers is indicated by
 red vertical lines on the top graph. The list of outliers is also
 displayed in the editable text box below the graphs.  The current
 values of the thresholds are displayed by the side of the
 corresponding graphs. These values may can be changed by the user
 either by pressing the up/down buttons, which increment/decrement
 the current value by 10%, or by specifying a new value in the text
 box.

 In Addition, the user can manually add or remove points from the
 list of outliers by editting the list. Note that the list is only
 updated once the curser points outside the text box (i.e. click the
 mouse somewhere outside the text box). Since any changes made by the
 user are overridden once the thresholds are updated, it is
 recommended to do any manual changes as the last step before saving.

 In the 'options' section of the GUI, the user can select to display the
 task-related design, the spectra of the global BOLD signal motion or
 task-related parameters, the level of task-correlated motion and
 task-correlated global BOLD signal, as well as the corrected analysis
 mask (without the influence of the identified outliers)

 By default art generates the following output files:
  Regressor files (one per session, stored in the same folders as the
   functional volumes, and named art_regression_outliers_*.mat and 
   art_regression_outliers_and_movement_*.mat). This files can be entered
   as covariates in the first-level analyses in order to effectively
   remove the identified outlier scans from further analyses
  Analysis mask (one file named art_mask.img defining the analysis mask
   after disregarding outlier scans). This file can be entered as an
   explicit analysis mask in the first-level analyses in order to
   avoid any influences of the outlier scans on the implicit analysis mask
   computation (on SPM you will also need to modify the defaults in order
   to skip the implicit masking operation, e.g. set defaults.mask.thresh =
   -inf) 

 Pressing the save button lets the user choose wheter to save the
 list of identified outliers, motion statistics, graphs, outlier
 regressors, or Analysis mask. 


 art filename.cfg
 Uses the configuration file filename.cfg to define the art analysis
 options (see example.cfg file for more information)

 See also <a href="art_batch.html" class="code" title="function art_batch_IDOR(spmfiles, outputdirs, subjids, mvthresh, zthresh)">art_batch</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>	Find file using regular expression</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function art_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub2" class="code">function UpdateGlobal(hObject, eventdata, handles, incr)</a></li><li><a href="#_sub3" class="code">function UpdateMovement(hObject, eventdata, handles, incr)</a></li><li><a href="#_sub4" class="code">function UpdateRotation(hObject, eventdata, handles, incr)</a></li><li><a href="#_sub5" class="code">function UpdateSummaryplot(hObject, eventdata, handles)</a></li><li><a href="#_sub6" class="code">function UnionOutliers(hObject, eventdata, handles)</a></li><li><a href="#_sub7" class="code">function diffsglobalandmotion_Callback(hObject, eventdata, handles,option_global,option_motion)</a></li><li><a href="#_sub8" class="code">function showCorr_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub9" class="code">function show_signal_corr_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub10" class="code">function showSpec_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function showSpec_Callback_setvisibility(handle,tmp)</a></li><li><a href="#_sub12" class="code">function showOptions_Callback(hObject, eventdata, handles, rescale_clim)</a></li><li><a href="#_sub13" class="code">function savefile_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub14" class="code">function savefile_Callback_SaveRegressor(handles)</a></li><li><a href="#_sub15" class="code">function savefile_Callback_SaveMask(handles,option)</a></li><li><a href="#_sub16" class="code">function [num_sess,global_type_flag,drop_flag,motionFileType,motion_threshold,global_threshold,use_diff_motion,use_diff_global,use_norms,SPMfile,mask_file,output_dir,P,M] = read_art_sess_file(sess_file)</a></li><li><a href="#_sub17" class="code">function z_up_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub18" class="code">function z_down_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub19" class="code">function zthresh_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub20" class="code">function mv_up_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub21" class="code">function mv_down_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub22" class="code">function mvthresh_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub23" class="code">function rt_up_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub24" class="code">function rt_down_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub25" class="code">function rtthresh_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub26" class="code">function norms_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub27" class="code">function all_outliers_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub28" class="code">function all_outliers_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub29" class="code">function varargout = art_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub30" class="code">function zthresh_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub31" class="code">function mvthresh_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub32" class="code">function rtthresh_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub33" class="code">function showDesign_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub34" class="code">function [idxremove_analysis,idxremove_globalsignal]=art_maskglobal_scan(data,VYi,VY1,VY1inv)</a></li><li><a href="#_sub35" class="code">function [SPM,design,names] = get_design(handles)</a></li><li><a href="#_sub36" class="code">function mp = read_siemens_motion_parm_file(fname)</a></li><li><a href="#_sub37" class="code">function m = make_spm_file_matrix(p)</a></li><li><a href="#_sub38" class="code">function z = zscore(x)</a></li><li><a href="#_sub39" class="code">function d=range(x)</a></li><li><a href="#_sub40" class="code">function fileout=strprepend(str1,file,str2)</a></li><li><a href="#_sub41" class="code">function cumdisp(txt)</a></li><li><a href="#_sub42" class="code">function z=prctile(x,p)</a></li><li><a href="#_sub43" class="code">function w=hanning(n)</a></li><li><a href="#_sub44" class="code">function filename=art_fullfile(varargin)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = art_IDOR(varargin)</a>
0002 <span class="comment">% art - module for automatic and manual detection and removal of outliers.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% art</span>
0005 <span class="comment">% Lauches the art GUI. This will prompt the user to enter the functional</span>
0006 <span class="comment">% volumes and motion pararameters (SPM, FSL, or Siemens supported) for one</span>
0007 <span class="comment">% subject (one or multiple sessions). It then displays four graphs:</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% The top graph is the global brain activation mean as a function of</span>
0010 <span class="comment">% time, with all of the identified outlier scans marked. Optionally it also</span>
0011 <span class="comment">% overlais the task-related regressors (SPM designs only) and break down of</span>
0012 <span class="comment">% number of identified outliers per condition.</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% The second graph shows the timeseries derived from the global BOLD signal</span>
0015 <span class="comment">% and used to identify potential outlier scans (either absolute or</span>
0016 <span class="comment">% scan-to-scan differences in the global BOLD signal normalized to</span>
0017 <span class="comment">% z-scores)</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% The third graph shows the timeseries derived from the subject motion</span>
0020 <span class="comment">% parameters and used to identify potential outlier scans (either the</span>
0021 <span class="comment">% absolute or scan-to-scan differences in the individual motion parameters</span>
0022 <span class="comment">% -x,y,z translation parameters and roll,pitch,yaw rotation parameters-, or</span>
0023 <span class="comment">% the absolute or scan-to-scan differences in a single 'composite motion'</span>
0024 <span class="comment">% measure -maximal movement of any voxel within the brain bounding box-)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Using default threshold values for each of the bottom three graphs</span>
0027 <span class="comment">% we define outliers as points that exceed the threshold in at least</span>
0028 <span class="comment">% one of the global signal or motion parameter graphs. The thresholds are</span>
0029 <span class="comment">% shown as horizontal black lines in each of the graphs.</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% Points which are identified as outliers, are indicated by a vertical</span>
0032 <span class="comment">% black line in the graph that corresponds to the outlying</span>
0033 <span class="comment">% parameter(s). For example, the if the absolute value of the Y motion</span>
0034 <span class="comment">% parameter for time t=17 is above the motion threshold, it is</span>
0035 <span class="comment">% identified as an outlier and indicated by a black vertical line at</span>
0036 <span class="comment">% t=17 in the third graph. The union of all outliers is indicated by</span>
0037 <span class="comment">% red vertical lines on the top graph. The list of outliers is also</span>
0038 <span class="comment">% displayed in the editable text box below the graphs.  The current</span>
0039 <span class="comment">% values of the thresholds are displayed by the side of the</span>
0040 <span class="comment">% corresponding graphs. These values may can be changed by the user</span>
0041 <span class="comment">% either by pressing the up/down buttons, which increment/decrement</span>
0042 <span class="comment">% the current value by 10%, or by specifying a new value in the text</span>
0043 <span class="comment">% box.</span>
0044 <span class="comment">%</span>
0045 <span class="comment">% In Addition, the user can manually add or remove points from the</span>
0046 <span class="comment">% list of outliers by editting the list. Note that the list is only</span>
0047 <span class="comment">% updated once the curser points outside the text box (i.e. click the</span>
0048 <span class="comment">% mouse somewhere outside the text box). Since any changes made by the</span>
0049 <span class="comment">% user are overridden once the thresholds are updated, it is</span>
0050 <span class="comment">% recommended to do any manual changes as the last step before saving.</span>
0051 <span class="comment">%</span>
0052 <span class="comment">% In the 'options' section of the GUI, the user can select to display the</span>
0053 <span class="comment">% task-related design, the spectra of the global BOLD signal motion or</span>
0054 <span class="comment">% task-related parameters, the level of task-correlated motion and</span>
0055 <span class="comment">% task-correlated global BOLD signal, as well as the corrected analysis</span>
0056 <span class="comment">% mask (without the influence of the identified outliers)</span>
0057 <span class="comment">%</span>
0058 <span class="comment">% By default art generates the following output files:</span>
0059 <span class="comment">%  Regressor files (one per session, stored in the same folders as the</span>
0060 <span class="comment">%   functional volumes, and named art_regression_outliers_*.mat and</span>
0061 <span class="comment">%   art_regression_outliers_and_movement_*.mat). This files can be entered</span>
0062 <span class="comment">%   as covariates in the first-level analyses in order to effectively</span>
0063 <span class="comment">%   remove the identified outlier scans from further analyses</span>
0064 <span class="comment">%  Analysis mask (one file named art_mask.img defining the analysis mask</span>
0065 <span class="comment">%   after disregarding outlier scans). This file can be entered as an</span>
0066 <span class="comment">%   explicit analysis mask in the first-level analyses in order to</span>
0067 <span class="comment">%   avoid any influences of the outlier scans on the implicit analysis mask</span>
0068 <span class="comment">%   computation (on SPM you will also need to modify the defaults in order</span>
0069 <span class="comment">%   to skip the implicit masking operation, e.g. set defaults.mask.thresh =</span>
0070 <span class="comment">%   -inf)</span>
0071 <span class="comment">%</span>
0072 <span class="comment">% Pressing the save button lets the user choose wheter to save the</span>
0073 <span class="comment">% list of identified outliers, motion statistics, graphs, outlier</span>
0074 <span class="comment">% regressors, or Analysis mask.</span>
0075 <span class="comment">%</span>
0076 <span class="comment">%</span>
0077 <span class="comment">% art filename.cfg</span>
0078 <span class="comment">% Uses the configuration file filename.cfg to define the art analysis</span>
0079 <span class="comment">% options (see example.cfg file for more information)</span>
0080 <span class="comment">%</span>
0081 <span class="comment">% See also art_batch</span>
0082 <span class="comment">%</span>
0083 
0084 <span class="comment">% ----------------------------------------------------------------------</span>
0085 <span class="comment">% - Added voxel-wise SNR and variability displays; save composite motion</span>
0086 <span class="comment">%   measure; clean-up code -Alfonso 06/11</span>
0087 <span class="comment">% - Added analysis mask option, modified pow spec display and other GUI display</span>
0088 <span class="comment">%   options, last update 9/25/09 - Sue, Alfonso and Darren</span>
0089 <span class="comment">% - if multiple sessions are specified, standard deviations are calculated</span>
0090 <span class="comment">%   within sessions</span>
0091 <span class="comment">%   oliver hinds 2008-04-23</span>
0092 <span class="comment">% - added support for reading siemens motion paramter file format</span>
0093 <span class="comment">%   oliver hinds 2008-04-23</span>
0094 <span class="comment">% - added ability to read file names and sesions from config file</span>
0095 <span class="comment">%   oliver hinds 2008-04-23</span>
0096 <span class="comment">% - tiny fix to make Matlab 6.5 compatible - Shay 5/14/07</span>
0097 <span class="comment">% - added &quot;signal-task correlation&quot; - 5/11/07</span>
0098 <span class="comment">% - added &quot;motion-task correlation&quot; and &quot;show spectrum&quot;</span>
0099 <span class="comment">% - minor GUI changes to support Windows and open a large graph</span>
0100 <span class="comment">%   in a separate window. Also fixed starnge motion params filename</span>
0101 <span class="comment">%   bug. Shay Mozes, 5/2/2007</span>
0102 <span class="comment">% - fixed bug in display of motion outlier on the graph, Shay Mozes 4/30/2007</span>
0103 <span class="comment">% - superimpose task conditions on the z-graph, Shay Mozes, 4/24/2007</span>
0104 <span class="comment">% - added support for SPM5, Shay Mozes, 4/2007</span>
0105 <span class="comment">% - now supporting FSL .par format, 4/9/2007</span>
0106 <span class="comment">% - new GUI and features Shay Mozes, 2006</span>
0107 <span class="comment">% + Mar. 2007 from art_global.m, by Paul Mazaika, April 2004.</span>
0108 <span class="comment">%   from artdetect4.m, by Jeff Cooper, Nov. 2002</span>
0109 <span class="comment">%   from artdetect3.m, by Sue Whitfield artdetect.m</span>
0110 <span class="comment">% Sue Whitfield 2000</span>
0111 
0112 
0113 
0114 <span class="comment">%% ---------------   GUI initialization  -----------------------------</span>
0115 <span class="comment">% GUIDE GUI default creation and callback support</span>
0116 <span class="comment">% --------------------------------------------------------------------</span>
0117 gui_Singleton = 0;
0118 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0119     <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0120     <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub1" class="code" title="subfunction art_OpeningFcn(hObject, eventdata, handles, varargin)">art_OpeningFcn</a>, <span class="keyword">...</span>
0121     <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub29" class="code" title="subfunction varargout = art_OutputFcn(hObject, eventdata, handles) ">art_OutputFcn</a>, <span class="keyword">...</span>
0122     <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0123     <span class="string">'gui_Callback'</span>,   []);
0124 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0125     gui_State.gui_Callback = str2func(varargin{1});
0126 <span class="keyword">end</span>
0127 
0128 <span class="keyword">if</span> nargout
0129     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0130 <span class="keyword">else</span>
0131     gui_mainfcn(gui_State, varargin{:});
0132 <span class="keyword">end</span>
0133 <span class="keyword">end</span>
0134 
0135 
0136 
0137 <span class="comment">%% ---------------   Main process -----------------------------</span>
0138 <span class="comment">% Main functionality of art (this process runs once for each dataset)</span>
0139 <span class="comment">% --------------------------------------------------------------------</span>
0140 
0141 <span class="comment">% -----------------------------------------------------------------------</span>
0142 <span class="comment">% ART_OPENINGFCN</span>
0143 <span class="comment">% This function is called before opening the gui.</span>
0144 <span class="comment">% It executes the main functionality of art, extracting the global signal</span>
0145 <span class="comment">% and movement parameters, defining the measures used to identify outliers,</span>
0146 <span class="comment">% printing movement statistics, and calling the Update* functions to</span>
0147 <span class="comment">% identify outliers and generate the corresponding plots</span>
0148 <span class="comment">% -----------------------------------------------------------------------</span>
0149 <a name="_sub1" href="#_subfunctions" class="code">function art_OpeningFcn(hObject, eventdata, handles, varargin)</a>
0150 <span class="comment">% -----------------------</span>
0151 <span class="comment">%Initialize</span>
0152 <span class="comment">% -----------------------</span>
0153 warning(<span class="string">'OFF'</span>,<span class="string">'all'</span>)
0154 <span class="comment">%find spm version</span>
0155 spm_ver = spm(<span class="string">'ver'</span>);
0156 <span class="keyword">switch</span>(spm_ver),
0157     <span class="keyword">case</span> <span class="string">'SPM99'</span>, spm_ver=1;
0158     <span class="keyword">case</span> <span class="string">'SPM2'</span>, spm_ver=2;
0159     <span class="keyword">case</span> <span class="string">'SPM5'</span>, spm_ver=5;
0160     <span class="keyword">case</span> {<span class="string">'SPM8b'</span>,<span class="string">'SPM8'</span>}, spm_ver=8;
0161     <span class="keyword">otherwise</span>, disp([<span class="string">'Warning! unrecognized SPM version '</span>,spm_ver]); spm_ver=5;
0162 <span class="keyword">end</span>
0163 
0164 <span class="comment">%clear data from previous sessions</span>
0165 <span class="keyword">try</span>
0166     setappdata(handles.showDesign,<span class="string">'SPM'</span>,[]);
0167     setappdata(handles.showDesign,<span class="string">'sessions'</span>,[]);
0168     setappdata(handles.showDesign,<span class="string">'SPMfile'</span>,[]);
0169     setappdata(handles.zthresh,<span class="string">'g'</span>,[]);
0170     setappdata(handles.mvthresh,<span class="string">'mv_data'</span>,[]);
0171     setappdata(handles.mvthresh,<span class="string">'altval'</span>,[]);
0172     setappdata(handles.rtthresh,<span class="string">'altval'</span>,[]);
0173     setappdata(handles.savefile,<span class="string">'path'</span>,[]);
0174     setappdata(handles.savefile,<span class="string">'datafiles'</span>,[]);
0175     setappdata(handles.savefile,<span class="string">'stats_file'</span>,[]);
0176     setappdata(handles.savefile,<span class="string">'analyses'</span>,[]);
0177     setappdata(handles.mvthresh,<span class="string">'mv_stats'</span>,[]);
0178     setappdata(handles.zthresh,<span class="string">'zoutliers'</span>,[]);
0179     setappdata(handles.mvthresh,<span class="string">'mv_norm_outliers'</span>,[]);
0180     setappdata(handles.mvthresh,<span class="string">'mv_x_outliers'</span>,[]);
0181     setappdata(handles.mvthresh,<span class="string">'mv_y_outliers'</span>,[]);
0182     setappdata(handles.mvthresh,<span class="string">'mv_z_outliers'</span>,[]);
0183     setappdata(handles.rtthresh,<span class="string">'rt_norm_outliers'</span>,[]);
0184     setappdata(handles.rtthresh,<span class="string">'rt_p_outliers'</span>,[]);
0185     setappdata(handles.rtthresh,<span class="string">'rt_r_outliers'</span>,[]);
0186     setappdata(handles.rtthresh,<span class="string">'rt_y_outliers'</span>,[]);
0187 <span class="keyword">catch</span> <span class="comment">%#ok&lt;*CTCH&gt;</span>
0188 <span class="keyword">end</span>
0189 
0190 <span class="comment">% ------------------------</span>
0191 <span class="comment">% Default values for outliers</span>
0192 <span class="comment">% ------------------------</span>
0193 z_thresh = 9.0;             <span class="comment">%global signal threshold</span>
0194 mvmt_thresh = 2.0;          <span class="comment">%absolute subject motion threshold</span>
0195 rotat_thresh = .05;         <span class="comment">%absolute subject rotation threshold</span>
0196 mvmt_diff_thresh = 2.0;     <span class="comment">%scan-to-scan subject motion threshold</span>
0197 rotat_diff_thresh = .02;    <span class="comment">%scan-to-scan subject rotation threshold</span>
0198 
0199 output_path=<span class="string">''</span>;
0200 sess_file=<span class="string">''</span>;
0201 stats_file=<span class="string">''</span>;
0202 
0203 
0204 <span class="comment">% look for args in varargin,</span>
0205 <span class="keyword">for</span> i=1:2:numel(varargin)
0206     <span class="keyword">if</span> strcmp(varargin{i}, <span class="string">'sess_file'</span>)
0207         sess_file = varargin{i+1};
0208     <span class="keyword">elseif</span> strcmp(varargin{i}, <span class="string">'stats_file'</span>)
0209         stats_file = varargin{i+1};
0210     <span class="keyword">elseif</span> strcmp(varargin{i}, <span class="string">'output_path'</span>)
0211         output_path = varargin{i+1};
0212     <span class="keyword">elseif</span> i==numel(varargin),
0213         <span class="keyword">if</span> exist(varargin{i},<span class="string">'file'</span>),
0214             [filepath,filename,fileext]=fileparts(varargin{i});
0215             <span class="keyword">if</span> strcmp(fileext,<span class="string">'.cfg'</span>), sess_file=varargin{i}; <span class="keyword">end</span>
0216         <span class="keyword">end</span>
0217     <span class="keyword">end</span>
0218 <span class="keyword">end</span>
0219 setappdata(handles.savefile,<span class="string">'stats_file'</span>,stats_file);
0220 
0221 
0222 <span class="comment">% ------------------------</span>
0223 <span class="comment">% Collect files</span>
0224 <span class="comment">% ------------------------</span>
0225 <span class="keyword">if</span> ~isempty(sess_file) <span class="comment">% read config</span>
0226     [num_sess,global_type_flag,drop_flag,motionFileType,motion_threshold,global_threshold,use_diff_motion,use_diff_global,use_norms,SPMfile,mask_file,output_dir,P,M] = <span class="keyword">...</span>
0227         <a href="#_sub16" class="code" title="subfunction [num_sess,global_type_flag,drop_flag,motionFileType,motion_threshold,global_threshold,use_diff_motion,use_diff_global,use_norms,SPMfile,mask_file,output_dir,P,M] = read_art_sess_file(sess_file)">read_art_sess_file</a>(sess_file); 
0228 <span class="keyword">else</span>
0229     motion_threshold=[];global_threshold=[];SPMfile=[];mask_file=[];output_dir=<span class="string">''</span>;
0230     use_diff_motion=1;use_diff_global=1;use_norms=1;
0231     num_sess = spm_input(<span class="string">'How many sessions?'</span>,1,<span class="string">'n'</span>,1,1);
0232     
0233     global_type_flag = spm_input(<span class="string">'Which global mean to use?'</span>, 1, <span class="string">'m'</span>, <span class="keyword">...</span>
0234         <span class="string">'Regular | User Mask'</span>,<span class="keyword">...</span>
0235         [1 2], 1);
0236     motionFileType = spm_input(<span class="string">'Select type of motion params file.'</span>,1,<span class="string">'m'</span>,<span class="keyword">...</span>
0237         <span class="string">' txt(SPM) | par(FSL) | txt(Siemens)'</span>, <span class="keyword">...</span>
0238         [0 1 2], 0);
0239     
0240     P=cell(1,num_sess);
0241     M=cell(1,num_sess);
0242     <span class="keyword">for</span> i = 1:num_sess
0243         <span class="keyword">switch</span> spm_ver
0244             <span class="keyword">case</span> {1,2}
0245                 P{i} = spm_get(Inf,<span class="string">'.img'</span>,[<span class="string">'Select functional volumes for session'</span>  num2str(i) <span class="string">':'</span>]);
0246             <span class="keyword">case</span> {5,8}
0247                 P{i} = spm_select(Inf,<span class="string">'image'</span>,[<span class="string">'Select functional volumes for session'</span>  num2str(i) <span class="string">':'</span>]);
0248                 <span class="comment">%P{i} = spm_select(Inf,'.*\.nii|.*\.img',['Select functional volumes for session'  num2str(i) ':']);</span>
0249         <span class="keyword">end</span>
0250         <span class="keyword">if</span> motionFileType == 0 <span class="comment">%SPM format</span>
0251             <span class="keyword">switch</span> spm_ver
0252                 <span class="keyword">case</span> {1,2}
0253                     mvmt_file = spm_get(1,<span class="string">'.txt'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0254                 <span class="keyword">case</span> {5,8}
0255                     mvmt_file = spm_select(1,<span class="string">'^.*\.txt$'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0256             <span class="keyword">end</span>
0257             M{i} =load(mvmt_file);
0258         <span class="keyword">elseif</span> motionFileType == 1 <span class="comment">%FSL format</span>
0259             <span class="keyword">switch</span> spm_ver
0260                 <span class="keyword">case</span> {1,2}
0261                     mvmt_file = spm_get(1,<span class="string">'.par'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0262                 <span class="keyword">case</span> {5,8}
0263                     mvmt_file = spm_select(1,<span class="string">'^.*\.par$'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0264             <span class="keyword">end</span>
0265             M{i} =load(mvmt_file);
0266         <span class="keyword">elseif</span> motionFileType == 2 <span class="comment">% Siemens MotionDetectionParameter.txt</span>
0267             <span class="keyword">switch</span> spm_ver
0268                 <span class="keyword">case</span> {1,2}
0269                     mvmt_file = spm_get(1,<span class="string">'.txt'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0270                 <span class="keyword">case</span> {5,8}
0271                     mvmt_file = spm_select(1,<span class="string">'^.*\.txt$'</span>,[<span class="string">'Select movement params file for session'</span> num2str(i) <span class="string">':'</span>]);
0272             <span class="keyword">end</span>
0273             M{i} = <a href="#_sub36" class="code" title="subfunction mp = read_siemens_motion_parm_file(fname)">read_siemens_motion_parm_file</a>(mvmt_file);
0274         <span class="keyword">end</span>
0275         output_path = fileparts(mvmt_file);
0276     <span class="keyword">end</span>
0277     drop_flag = 0;
0278 <span class="keyword">end</span>
0279 
0280 <span class="keyword">if</span> global_type_flag==2,
0281     <span class="keyword">if</span> isempty(mask_file),
0282         mask_file = spm_select(1, <span class="string">'.*\.nii|.*\.img'</span>, <span class="string">'Select mask image in functional space'</span>);
0283     <span class="keyword">end</span>
0284     mask=spm_vol(mask_file);
0285 <span class="keyword">end</span>
0286 setappdata(handles.showDesign,<span class="string">'sessions'</span>,-(1:num_sess));
0287 setappdata(handles.showDesign,<span class="string">'SPMfile'</span>,SPMfile);
0288 <span class="keyword">if</span> ~isempty(SPMfile), temp=load(SPMfile); setappdata(handles.showDesign,<span class="string">'SPM'</span>,temp.SPM); clear temp; <span class="keyword">end</span>
0289 datafiles=cell(1,length(P));<span class="keyword">for</span> i=1:length(P),<span class="keyword">if</span> ~isempty(P{i}),datafiles{i}=strtrim(P{i}(1,:));<span class="keyword">else</span> datafiles{i}=[];<span class="keyword">end</span>;<span class="keyword">end</span>; <span class="comment">% &lt;alfnie&gt;: keep filenames of functional data (first scan per session only)</span>
0290 <span class="keyword">if</span> ~isempty(motion_threshold), mvmt_thresh=motion_threshold; mvmt_diff_thresh=motion_threshold; <span class="keyword">end</span>
0291 <span class="keyword">if</span> ~isempty(global_threshold), z_thresh=global_threshold; <span class="keyword">end</span>
0292 <span class="keyword">if</span> drop_flag, disp(<span class="string">'warning: explicitly dropping 1st scan no longer supported. Edit the ''all outliers'' box to specify any number of additional outlier scans'</span>); <span class="keyword">end</span> <span class="comment">% dropflag no longer supported: (alfnie 06/11)</span>
0293 
0294 mv_data = [];
0295 <span class="keyword">for</span> i = 1:length(M)
0296     mv_data = vertcat(mv_data,M{i});
0297 <span class="keyword">end</span>
0298 
0299 <span class="comment">%in FSL order of fields is three Euler angles (x,y,z in radians) then three translation params (x,y,z in mm).</span>
0300 <span class="comment">%in SPM: x y z pitch roll yaw</span>
0301 <span class="keyword">if</span> motionFileType == 1
0302     tmp = mv_data(:,1:3);
0303     mv_data(:,1:3) = mv_data(:,4:6);
0304     mv_data(:,4:6) = tmp;
0305 <span class="keyword">end</span>
0306 
0307 
0308 <span class="comment">% ---------------------------------------</span>
0309 <span class="comment">% Compute Global signal and analysis mask</span>
0310 <span class="comment">% ---------------------------------------</span>
0311 g = cell(1,num_sess); <span class="comment">% g is a cell array of the global mean for each scan in each session</span>
0312 diff_similiarity = cell(1,num_sess); <span class="comment">% g is a cell array of the global mean for each scan in each session</span>
0313 gsigma=g;gmean=g;dgsigma=g;dgmean=g;
0314 maskscan={};
0315 Data_Sum=0;
0316 Data_SumSquared=0;
0317 VY=cell(1,num_sess);
0318 <a href="#_sub41" class="code" title="subfunction cumdisp(txt)">cumdisp</a>;
0319 <span class="keyword">for</span> sess=1:num_sess
0320     fprintf(<span class="string">'%-4s: '</span>,[<span class="string">'Mapping files for session '</span> num2str(sess) <span class="string">'...'</span>]);
0321     VY{sess}     = spm_vol(P{sess});
0322     fprintf(<span class="string">'%3s\n'</span>,<span class="string">'...done'</span>)
0323     
0324     <span class="keyword">switch</span> spm_ver
0325         <span class="keyword">case</span> {1,2}
0326             <span class="keyword">if</span> any(any(diff(cat(1,VY{sess}.dim),1,1),1)&amp;[1,1,1,0])
0327                 error(<span class="string">'images do not all have the same dimensions'</span>)
0328             <span class="keyword">end</span>
0329         <span class="keyword">case</span> {5,8}
0330             <span class="keyword">if</span> any(any(diff(cat(1,VY{sess}.dim),1,1),1))
0331                 error(<span class="string">'images do not all have the same dimensions'</span>)
0332             <span class="keyword">end</span>
0333     <span class="keyword">end</span>
0334     
0335     <span class="comment">% --------------------------------------------------</span>
0336     <span class="comment">% Extracts global-signal mask and (optinally) compute analysis mask</span>
0337     <span class="comment">% note: scan-specific global-signal mask = voxels above mean(all voxels)/8</span>
0338     <span class="comment">%       scan-specific analysis mask = voxels above 0.8*mean(global-signal mask)</span>
0339     <span class="comment">%       global-signal mask = intersection of {scan-specific global-signal mask}</span>
0340     <span class="comment">%       analysis mask = intersection of {scan-specific analysis mask}</span>
0341     <span class="comment">% --------------------------------------------------</span>
0342     nscans = numel(VY{sess});
0343     g{sess} = zeros(nscans,4);
0344     fprintf(<span class="string">'%-4s: %3s'</span>,<span class="string">'Calculating globals...'</span>,<span class="string">' '</span>)
0345     VY1inv=pinv(VY{sess}(1).mat);
0346     [tempx,tempy,tempz]=ind2sub(VY{sess}(1).dim(1:3),1:prod(VY{sess}(1).dim(1:3)));
0347     xyz_voxel=[tempx(:),tempy(:),tempz(:),ones(numel(tempx),1)]';
0348     xyz=VY{sess}(1).mat*xyz_voxel;
0349     <span class="keyword">if</span> global_type_flag==1  <span class="comment">% regular mean : Global-conjunction (uses conjunction of individual scan masks; individual scan mask are defined as voxels above mean/8 for each scan; see art_maskglobal_scan)</span>
0350         Mask=ones(VY{sess}(1).dim(1:3));
0351         <span class="keyword">for</span> i = 1:nscans,
0352             temp=reshape(spm_get_data(VY{sess}(i),xyz_voxel),VY{sess}(i).dim); 
0353             [maskscan{end+1},masktemp]=<a href="#_sub34" class="code" title="subfunction [idxremove_analysis,idxremove_globalsignal]=art_maskglobal_scan(data,VYi,VY1,VY1inv)">art_maskglobal_scan</a>(temp,VY{sess}(i),VY{sess}(1),VY1inv); <span class="comment">%#ok&lt;AGROW&gt;</span>
0354             Mask(masktemp)=0;
0355             <a href="#_sub41" class="code" title="subfunction cumdisp(txt)">cumdisp</a>([num2str(i),<span class="string">'/'</span>,num2str(nscans)]);
0356         <span class="keyword">end</span>
0357     <span class="keyword">elseif</span> global_type_flag==2  <span class="comment">% user-defined mask</span>
0358         Mask=spm_get_data(mask,pinv(mask.mat)*xyz);
0359     <span class="keyword">end</span>
0360     idxMask=<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(Mask);
0361 
0362     <span class="comment">% --------------------------------------------------</span>
0363     <span class="comment">% computes global signal</span>
0364     <span class="comment">% --------------------------------------------------</span>
0365     notcoregistered=length(VY{sess})&gt;1&amp;&amp;any(any(VY{sess}(2).mat~=VY{sess}(1).mat));
0366     badmask=(numel(idxMask)&lt;numel(Mask)/10) &amp;&amp; global_type_flag~=2;
0367     <span class="keyword">for</span> i = 1:nscans,
0368         <span class="keyword">if</span> notcoregistered, temp=spm_get_data(VY{sess}(i),pinv(VY{sess}(i).mat)*xyz);
0369         <span class="keyword">else</span> temp=reshape(spm_get_data(VY{sess}(i),xyz_voxel),VY{sess}(i).dim); <span class="comment">%temp=spm_read_vols(VY{sess}(i));</span>
0370         <span class="keyword">end</span>
0371         <span class="keyword">if</span> badmask, g{sess}(i) = spm_global(VY{sess}(i));
0372         <span class="keyword">else</span> g{sess}(i)=mean(temp(idxMask));
0373             
0374             <span class="comment">% Sebastian</span>
0375             <span class="keyword">if</span> i&gt;1
0376                 diff_similiarity{sess}(i-1) = corr( temp(idxMask)', temp_before' );
0377             <span class="keyword">end</span>
0378             temp_before = temp(idxMask);
0379         <span class="keyword">end</span>
0380         Data_Sum=Data_Sum+temp;
0381         Data_SumSquared=Data_SumSquared+temp.^2;
0382         <span class="comment">%imagesc(Data_Sum(:,:,30));colorbar;drawnow;</span>
0383     <span class="keyword">end</span>
0384     fprintf(<span class="string">'...done'</span>);<a href="#_sub41" class="code" title="subfunction cumdisp(txt)">cumdisp</a>;
0385     
0386     <span class="comment">% --------------------------------------------------</span>
0387     <span class="comment">% Compute derived signals for outlier identification</span>
0388     <span class="comment">% --------------------------------------------------</span>
0389     <span class="comment">% g{sess} columns:</span>
0390     <span class="comment">% 1: global signal</span>
0391     <span class="comment">% 2: standardized global signal</span>
0392     <span class="comment">% 3: scan-to-scan differences in global signal</span>
0393     <span class="comment">% 4: standardized scan-to-scan differences in global signal</span>
0394     
0395     gsigma{sess} = .7413*diff(<a href="#_sub42" class="code" title="subfunction z=prctile(x,p)">prctile</a>(g{sess}(:,1),[25,75]));gsigma{sess}(gsigma{sess}==0)=1; <span class="comment">% robus standard-deviation</span>
0396     gmean{sess} = median(g{sess}(:,1)); <span class="comment">% robust mean</span>
0397     g{sess}(:,2)=(g{sess}(:,1)-gmean{sess})/max(eps,gsigma{sess}); <span class="comment">% z-score</span>
0398     g{sess}(2:<span class="keyword">end</span>,3)=diff(g{sess}(:,1),1,1);
0399     dgsigma{sess} = .7413*diff(<a href="#_sub42" class="code" title="subfunction z=prctile(x,p)">prctile</a>(g{sess}(:,3),[25,75]));dgsigma{sess}(dgsigma{sess}==0)=1;
0400     dgmean{sess} = median(g{sess}(:,3));
0401     g{sess}(2:<span class="keyword">end</span>,4)=(g{sess}(2:<span class="keyword">end</span>,3)-dgmean{sess})/max(eps,dgsigma{sess});
0402     z_thresh = 0.1*round(z_thresh*10);
0403 <span class="keyword">end</span>
0404 
0405 art_mask_temporalfile=[<span class="string">'art_mask_temporalfile'</span>,char(<span class="string">'0'</span>+floor(10*rand(1,8))),<span class="string">'.mat'</span>];
0406 VY=cat(1,VY{:}); VY1=VY(1); <span class="comment">%#ok&lt;NASGU&gt;</span>
0407 <span class="keyword">try</span>
0408     save(fullfile(output_dir,art_mask_temporalfile),<span class="string">'maskscan'</span>,<span class="string">'VY1'</span>,<span class="string">'VY'</span>,<span class="string">'notcoregistered'</span>,<span class="string">'xyz'</span>,<span class="string">'xyz_voxel'</span>,<span class="string">'Data_Sum'</span>,<span class="string">'Data_SumSquared'</span>); 
0409 <span class="keyword">catch</span>
0410     disp(<span class="string">'warning: unable to write to '</span>,output_dir,<span class="string">' folder. Writing output files to '</span>,pwd,<span class="string">' instead.'</span>);
0411     output_dir=pwd;
0412     save(fullfile(output_dir,art_mask_temporalfile),<span class="string">'maskscan'</span>,<span class="string">'VY1'</span>,<span class="string">'VY'</span>,<span class="string">'notcoregistered'</span>,<span class="string">'xyz'</span>,<span class="string">'xyz_voxel'</span>,<span class="string">'Data_Sum'</span>,<span class="string">'Data_SumSquared'</span>); 
0413 <span class="keyword">end</span>
0414 set(handles.figure1,<span class="string">'closerequestfcn'</span>,[<span class="string">'try,if isunix,txt=''rm ''; else txt=''del ''; end; [nill,ok]=system([txt,'''</span>,fullfile(output_dir,art_mask_temporalfile),<span class="string">''']);catch;end;close(gcbf);'</span>]);
0415 
0416 <span class="comment">%update text fields</span>
0417 set(handles.data_stdv,<span class="string">'String'</span>,num2str(cat(2,gsigma{:}),<span class="string">'%0.1f '</span>));
0418 set(handles.zthresh,<span class="string">'String'</span>,num2str(z_thresh));
0419 set(handles.mvthresh,<span class="string">'String'</span>,num2str(mvmt_thresh));
0420 set(handles.rtthresh,<span class="string">'String'</span>,num2str(rotat_thresh));
0421 
0422 <span class="comment">% ------------------------------------------------------------------------</span>
0423 <span class="comment">% Compute Movement parameters and derived signals for outlier identification</span>
0424 <span class="comment">% ------------------------------------------------------------------------</span>
0425 <span class="comment">% mv_data columns:</span>
0426 <span class="comment">% 1-6   : raw movement parameters</span>
0427 <span class="comment">% 7     : euclidean norm of raw movement parameters</span>
0428 <span class="comment">% 8-13  : scan-to-scan differences in raw movement parameters</span>
0429 <span class="comment">% 14-31 : 6 control points trajectories (placed on center of faces of bounding box; x,y,z coordinates for each control point)</span>
0430 <span class="comment">% 32    : composite measure: euclidean norm of control point trajectories</span>
0431 <span class="comment">% 33-51 : scan-to-scan differences in 6 control points trajectories</span>
0432 <span class="comment">% 52    : composite measure: max scan-to-scan movement across the 6 control points</span>
0433 
0434 mv_data=[mv_data,zeros([size(mv_data,1),51-size(mv_data,2)])];
0435 respos=diag([70,70,75]);resneg=diag([-70,-110,-45]);
0436 res=[respos,zeros(3,1),zeros(3,4),zeros(3,4),eye(3),zeros(3,1); <span class="comment">% 6 control points: [+x,+y,+z,-x,-y,-z];</span>
0437     zeros(3,4),respos,zeros(3,1),zeros(3,4),eye(3),zeros(3,1);
0438     zeros(3,4),zeros(3,4),respos,zeros(3,1),eye(3),zeros(3,1);
0439     resneg,zeros(3,1),zeros(3,4),zeros(3,4),eye(3),zeros(3,1);
0440     zeros(3,4),resneg,zeros(3,1),zeros(3,4),eye(3),zeros(3,1);
0441     zeros(3,4),zeros(3,4),resneg,zeros(3,1),eye(3),zeros(3,1);];
0442 <span class="keyword">for</span> i=1:size(mv_data,1)
0443     temp=spm_matrix([1*mv_data(i,1:3),mv_data(i,4:6)]); temp=temp(:)';
0444     mv_data(i,14:31)=temp*res';
0445 <span class="keyword">end</span>
0446 cur_sess_start=0;
0447 <span class="keyword">for</span> sess=1:num_sess
0448     n=length(g{sess}(:,1));
0449     mv_data(cur_sess_start+(1:n),7) = sqrt(sum(abs(mv_data(cur_sess_start+(1:n),1:3)).^2,2));
0450     mv_data(cur_sess_start+(2:n),8:13)  = diff(mv_data(cur_sess_start+(1:n),1:6),1,1);
0451     mv_data(cur_sess_start+(1:n),32)=sqrt(mean(abs(detrend(mv_data(cur_sess_start+(1:n),14:31),<span class="string">'constant'</span>)).^2,2));
0452     mv_data(cur_sess_start+(2:n),33:50)=diff(mv_data(cur_sess_start+(1:n),14:31),1,1);
0453     mv_data(cur_sess_start+(2:n),51)=max(sqrt(sum(reshape(abs(mv_data(cur_sess_start+(2:n),33:50)).^2,[n-1,3,6]),2)),[],3);
0454     cur_sess_start = cur_sess_start + n;
0455 <span class="keyword">end</span>
0456 
0457 <span class="comment">%save application data for use in callbacks</span>
0458 setappdata(handles.zthresh,<span class="string">'g'</span>,g);
0459 setappdata(handles.mvthresh,<span class="string">'mv_data'</span>,mv_data);
0460 setappdata(handles.mvthresh,<span class="string">'altval'</span>,num2str(mvmt_diff_thresh));
0461 setappdata(handles.rtthresh,<span class="string">'altval'</span>,num2str(rotat_diff_thresh));
0462 setappdata(handles.savefile,<span class="string">'path'</span>,output_path);
0463 setappdata(handles.savefile,<span class="string">'dir'</span>,output_dir);
0464 setappdata(handles.savefile,<span class="string">'datafiles'</span>,datafiles);
0465 setappdata(handles.savefile,<span class="string">'spm_ver'</span>,spm_ver);
0466 setappdata(handles.savefile,<span class="string">'mv_data_raw'</span>,M);
0467 setappdata(handles.savefile,<span class="string">'art_mask_temporalfile'</span>,art_mask_temporalfile);
0468 
0469 <span class="keyword">if</span> ~isempty(SPMfile), set(handles.showDesign,<span class="string">'Value'</span>,get(handles.showDesign,<span class="string">'Max'</span>)); <span class="keyword">end</span>
0470 set(handles.norms,<span class="string">'Value'</span>,use_norms);
0471 set(handles.diff1,<span class="string">'value'</span>,use_diff_global);
0472 set(handles.diff2,<span class="string">'value'</span>,use_diff_motion);
0473 <span class="keyword">if</span> use_diff_global||use_diff_motion
0474     <a href="#_sub7" class="code" title="subfunction diffsglobalandmotion_Callback(hObject, eventdata, handles,option_global,option_motion)">diffsglobalandmotion_Callback</a>(hObject, [], handles, use_diff_global, use_diff_motion);
0475 <span class="keyword">else</span>
0476     <a href="#_sub2" class="code" title="subfunction UpdateGlobal(hObject, eventdata, handles, incr) ">UpdateGlobal</a>(hObject, eventdata, handles,1.0);
0477     <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,1.0);
0478     <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,1.0);
0479     <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
0480     <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
0481 <span class="keyword">end</span>
0482 
0483 idx=str2num(get(handles.all_outliers, <span class="string">'String'</span>)); <span class="comment">%#ok&lt;*ST2NM&gt;</span>
0484 <span class="keyword">for</span> sess=1:num_sess
0485     fprintf(<span class="string">'\nSession %d global statistics -  mean: %7.4f stdv: %7.4f'</span>,sess,gmean{sess},gsigma{sess});
0486 <span class="keyword">end</span>
0487 fprintf(<span class="string">'\n'</span>);
0488 fprintf(<span class="string">'Outlier detection: %d identified outliers\n'</span>,length(idx));
0489 
0490 <span class="comment">% ------------------------</span>
0491 <span class="comment">% Compute and print statistics of movement</span>
0492 <span class="comment">%--------------------------</span>
0493 mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
0494 mv_stats = [mean(abs(mv_data)); std(abs(mv_data)); max(abs(mv_data)) ];
0495 setappdata(handles.mvthresh,<span class="string">'mv_stats'</span>,mv_stats);
0496 fprintf(<span class="string">'\n\nStatistics of movement data:\n\n'</span>);
0497 fprintf(<span class="string">'%5s%10s%10s%10s%11s%10s%9s%10s\n'</span>,<span class="string">' '</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">' pitch'</span>,<span class="string">'roll'</span>,<span class="string">'yaw'</span>,<span class="string">'norm'</span>);
0498 fprintf(<span class="string">'%7s%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n'</span>,<span class="string">'mean '</span>,mv_stats(1,1:3),mv_stats(1,4:6),mv_stats(1,32));
0499 fprintf(<span class="string">'%7s%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n'</span>,<span class="string">'stdv '</span>,mv_stats(2,1:3),mv_stats(2,4:6),mv_stats(2,32));
0500 fprintf(<span class="string">'%7s%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n\n\n'</span>,<span class="string">'max '</span>,mv_stats(3,1:3),mv_stats(3,4:6),mv_stats(3,32));
0501 <span class="comment">% BEGIN ohinds 2008-04-23: save stats to file</span>
0502 <span class="keyword">if</span> ~isempty(stats_file)
0503     <span class="keyword">if</span> isempty(fileparts(stats_file)),stats_file=fullfile(output_dir,stats_file);<span class="keyword">end</span>
0504     fp = fopen(stats_file,<span class="string">'w'</span>);
0505     <span class="keyword">if</span> fp ~= -1
0506         fprintf(<span class="string">'saving global motion stats to %s\n'</span>,[pwd <span class="string">'/'</span> stats_file]);
0507         fprintf(fp,<span class="string">'%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n'</span>,mv_stats(1,1:3),mv_stats(1,4:6),mv_stats(1,32));
0508         fprintf(fp,<span class="string">'%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n'</span>,mv_stats(2,1:3),mv_stats(2,4:6),mv_stats(2,32));
0509         fprintf(fp,<span class="string">'%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f%10.4f\n\n\n'</span>,mv_stats(3,1:3),mv_stats(3,4:6),mv_stats(3,32));
0510         fclose(fp);
0511     <span class="keyword">end</span>
0512 <span class="keyword">end</span>
0513 <span class="comment">% END ohinds 2008-04-23: save stats to file</span>
0514 
0515 <span class="comment">% Choose default command line output for art</span>
0516 handles.output = hObject;
0517 <span class="comment">% Update handles structure</span>
0518 guidata(hObject, handles);
0519 set(handles.figure1,<span class="string">'resizefcn'</span>,<span class="string">'art(''showOptions_Callback'',gcbo,[],guidata(gcbo))'</span>);
0520 
0521 <span class="comment">% --------------------------------------------------------</span>
0522 <span class="comment">% Saves regressor matrix with outliers &amp; new analysis mask</span>
0523 <span class="comment">%---------------------------------------------------------</span>
0524 <a href="#_sub14" class="code" title="subfunction savefile_Callback_SaveRegressor(handles)">savefile_Callback_SaveRegressor</a>(handles);
0525 <a href="#_sub15" class="code" title="subfunction savefile_Callback_SaveMask(handles,option)">savefile_Callback_SaveMask</a>(handles);
0526 <span class="keyword">end</span>
0527 
0528 
0529 
0530 
0531 <span class="comment">%% ---------------   GUI callback functions --------------------------</span>
0532 <span class="comment">% Processing steps for each of the art GUI options</span>
0533 <span class="comment">% --------------------------------------------------------------------</span>
0534 
0535 <span class="comment">% -----------------------------------------------------------------------</span>
0536 <span class="comment">% UPDATEGLOBAL</span>
0537 <span class="comment">% This function identifies outliers based on the BOLD globalsignal and</span>
0538 <span class="comment">% generates the corresponding plot (gui 2nd plot from the top)</span>
0539 <span class="comment">% -----------------------------------------------------------------------</span>
0540 <a name="_sub2" href="#_subfunctions" class="code">function UpdateGlobal(hObject, eventdata, handles, incr) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0541 
0542 <span class="comment">%get data</span>
0543 z_thresh = str2num(get(handles.zthresh,<span class="string">'String'</span>));
0544 g = getappdata(handles.zthresh,<span class="string">'g'</span>);
0545 num_sess = length(g);
0546 
0547 <span class="comment">%calc new outliers</span>
0548 <span class="comment">% BEGIN ohinds 2008-04-23: plot zscores</span>
0549 axes(handles.zvalue);
0550 cla;
0551 hold on;
0552 cur_sess_start=1;
0553 z_thresh = z_thresh*incr; 
0554 idxind=2;
0555 out_idx = cell(1,num_sess);
0556 <span class="keyword">for</span> sess=1:num_sess
0557     <span class="keyword">if</span> get(handles.diff1,<span class="string">'value'</span>),
0558         out_idx{sess} = cur_sess_start+(<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(abs(g{sess}(:,idxind)) &gt; z_thresh|abs([g{sess}(2:<span class="keyword">end</span>,idxind);0]) &gt; z_thresh))'-1; 
0559     <span class="keyword">else</span>
0560         out_idx{sess} = cur_sess_start+(<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(abs(g{sess}(:,idxind)) &gt; z_thresh))'-1; 
0561     <span class="keyword">end</span>
0562     <span class="comment">%update plot</span>
0563     plot(cur_sess_start:cur_sess_start+size(g{sess},1)-1, g{sess}(:,idxind));
0564     cur_sess_start = cur_sess_start + size(g{sess},1);
0565 <span class="keyword">end</span>
0566 out_idx=cat(2,out_idx{:});
0567 set(gca,<span class="string">'xlim'</span>,[0,cur_sess_start]);
0568 l=ylabel(<span class="string">'global mean\newline     [std]'</span>);
0569 set(l,<span class="string">'VerticalAlignment'</span>,<span class="string">'bottom'</span>,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
0570 set(gca,<span class="string">'XTickLabel'</span>,[]);
0571 
0572 thresh_x = 1:cur_sess_start-1;
0573 thresh_y = z_thresh*ones(1,length(thresh_x));
0574 line(thresh_x, thresh_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0575 line(thresh_x, -1*thresh_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0576 
0577 <span class="comment">%update text</span>
0578 set(handles.zthresh,<span class="string">'String'</span>,num2str(z_thresh));
0579 setappdata(handles.zthresh,<span class="string">'zoutliers'</span>,out_idx);
0580 hold off;
0581 <span class="comment">% END ohinds 2008-04-23: plot zscores</span>
0582 
0583 <span class="comment">%plot outliers</span>
0584 axes_lim = get(gca, <span class="string">'YLim'</span>);
0585 axes_height = axes_lim;
0586 <span class="keyword">for</span> i = 1:length(out_idx)
0587     line((out_idx(i)*ones(1, length(axes_height))), axes_height, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0588 <span class="keyword">end</span>
0589 <span class="keyword">end</span>
0590 
0591 
0592 <span class="comment">% -----------------------------------------------------------------------</span>
0593 <span class="comment">% UPDATEMOVEMENT</span>
0594 <span class="comment">% This function identifies outliers based on the subject movement</span>
0595 <span class="comment">% parameters (either translation parameters or composite motion) and</span>
0596 <span class="comment">% generates the corresponding plot (gui 3rd plot from the top)</span>
0597 <span class="comment">% -----------------------------------------------------------------------</span>
0598 <a name="_sub3" href="#_subfunctions" class="code">function UpdateMovement(hObject, eventdata, handles, incr) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0599 
0600 <span class="comment">%get data</span>
0601 mvmt_thresh = str2num(get(handles.mvthresh,<span class="string">'String'</span>));
0602 mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
0603 
0604 <span class="comment">%calc new outliers</span>
0605 mvmt_thresh = mvmt_thresh*incr;
0606 
0607 <span class="keyword">if</span> get(handles.diff2,<span class="string">'value'</span>),
0608     out_mvmt_idx = (<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(abs(mv_data(:,1:3)) &gt; mvmt_thresh | [abs(mv_data(2:<span class="keyword">end</span>,1:3));[0,0,0]] &gt; mvmt_thresh ))';
0609 <span class="keyword">else</span>
0610     out_mvmt_idx = (<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(abs(mv_data(:,1:3)) &gt; mvmt_thresh))';
0611 <span class="keyword">end</span>
0612 out_mvmt_idx_X=out_mvmt_idx(out_mvmt_idx&lt;=size(mv_data,1));
0613 out_mvmt_idx_Y=out_mvmt_idx(out_mvmt_idx&gt;size(mv_data,1)&amp;out_mvmt_idx&lt;=2*size(mv_data,1))-size(mv_data,1);
0614 out_mvmt_idx_Z=out_mvmt_idx(out_mvmt_idx&gt;2*size(mv_data,1))-2*size(mv_data,1);
0615 
0616 <span class="comment">%find norm outliers</span>
0617 <span class="keyword">if</span> (get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0618     normv=mv_data(:,32);
0619     <span class="keyword">if</span> get(handles.diff2,<span class="string">'value'</span>)
0620         out_mvmt_idx_norm = <a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(normv&gt;mvmt_thresh|[normv(2:end);0]&gt;mvmt_thresh);
0621     <span class="keyword">else</span>
0622         out_mvmt_idx_norm = <a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(normv&gt;mvmt_thresh);
0623     <span class="keyword">end</span>
0624     out_mvmt_idx_norm = out_mvmt_idx_norm';
0625     setappdata(handles.mvthresh,<span class="string">'mv_norm_outliers'</span>,out_mvmt_idx_norm);
0626 <span class="keyword">end</span>
0627 
0628 <span class="comment">%update text</span>
0629 set(handles.mvthresh,<span class="string">'String'</span>,num2str(mvmt_thresh));
0630 setappdata(handles.mvthresh,<span class="string">'mv_x_outliers'</span>,out_mvmt_idx_X);
0631 setappdata(handles.mvthresh,<span class="string">'mv_y_outliers'</span>,out_mvmt_idx_Y);
0632 setappdata(handles.mvthresh,<span class="string">'mv_z_outliers'</span>,out_mvmt_idx_Z);
0633 
0634 axes(handles.mvmtGraph);
0635 cla;
0636 <span class="keyword">if</span> (get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0637     plot(normv);
0638     set(gca,<span class="string">'xlim'</span>,[0,length(normv)+1]);
0639 <span class="keyword">else</span>
0640     plot(mv_data(:,1:3));
0641     set(gca,<span class="string">'xlim'</span>,[0,size(mv_data,1)+1]);
0642 <span class="keyword">end</span>
0643 l=ylabel(<span class="string">'movement \newline   [mm]'</span>);
0644 set(l,<span class="string">'VerticalAlignment'</span>,<span class="string">'bottom'</span>,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
0645 set(gca,<span class="string">'XTickLabel'</span>,[]);
0646 <span class="keyword">if</span> (get(handles.norms,<span class="string">'Value'</span>) ~= get(handles.norms,<span class="string">'Max'</span>))
0647     legend(<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>,<span class="string">'Location'</span>,<span class="string">'East'</span>);
0648 <span class="keyword">end</span>
0649 h = gca;
0650 set(h,<span class="string">'Ygrid'</span>,<span class="string">'on'</span>);
0651 
0652 thresh_mv_x = 1:size(mv_data,1);
0653 thresh_mv_y = mvmt_thresh*ones(1,size(mv_data,1));
0654 line(thresh_mv_x, thresh_mv_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0655 <span class="keyword">if</span> ~(get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0656     line(thresh_mv_x, -1*thresh_mv_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0657 <span class="keyword">end</span>
0658 
0659 axes_lim = get(gca, <span class="string">'YLim'</span>);
0660 axes_height = axes_lim;
0661 <span class="keyword">if</span> ~(get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0662     <span class="keyword">for</span> i = 1:length(out_mvmt_idx_X)
0663         line((out_mvmt_idx_X(i)*ones(1, length(axes_height))), axes_height, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0664     <span class="keyword">end</span>
0665     <span class="keyword">for</span> i = 1:length(out_mvmt_idx_Y)
0666         line((out_mvmt_idx_Y(i)*ones(1, length(axes_height))), axes_height, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0667     <span class="keyword">end</span>
0668     <span class="keyword">for</span> i = 1:length(out_mvmt_idx_Z)
0669         line((out_mvmt_idx_Z(i)*ones(1, length(axes_height))), axes_height, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0670     <span class="keyword">end</span>
0671 <span class="keyword">else</span>
0672     <span class="keyword">for</span> i = 1:length(out_mvmt_idx_norm)
0673         line((out_mvmt_idx_norm(i)*ones(1, length(axes_height))), axes_height, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0674     <span class="keyword">end</span>
0675 <span class="keyword">end</span>
0676 <span class="keyword">end</span>
0677 
0678 
0679 <span class="comment">% -----------------------------------------------------------------------</span>
0680 <span class="comment">% UPDATEROTATION</span>
0681 <span class="comment">% This function identifies outliers based on the subject rotation</span>
0682 <span class="comment">% parameters and generates the corresponding plot (gui 4th plot from the top)</span>
0683 <span class="comment">% (note: only available when not using composite movement measures)</span>
0684 <span class="comment">% -----------------------------------------------------------------------</span>
0685 <a name="_sub4" href="#_subfunctions" class="code">function UpdateRotation(hObject, eventdata, handles, incr) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0686 
0687 <span class="comment">%get data</span>
0688 rotat_thresh = str2num(get(handles.rtthresh,<span class="string">'String'</span>));
0689 mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
0690 
0691 <span class="comment">%calc new outliers</span>
0692 rotat_thresh = rotat_thresh*incr;
0693 
0694 out_rotat_idx = (<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(abs(mv_data(:,4:6)) &gt; rotat_thresh))';
0695 out_rotat_idx_p=out_rotat_idx(out_rotat_idx&lt;=size(mv_data,1));
0696 out_rotat_idx_r=out_rotat_idx(out_rotat_idx&gt;size(mv_data,1)&amp;out_rotat_idx&lt;=2*size(mv_data,1))-size(mv_data,1);
0697 out_rotat_idx_y=out_rotat_idx(out_rotat_idx&gt;2*size(mv_data,1))-2*size(mv_data,1);
0698 <span class="comment">%update text</span>
0699 set(handles.rtthresh,<span class="string">'String'</span>,num2str(rotat_thresh));
0700 setappdata(handles.rtthresh,<span class="string">'rt_p_outliers'</span>,out_rotat_idx_p);
0701 setappdata(handles.rtthresh,<span class="string">'rt_r_outliers'</span>,out_rotat_idx_r);
0702 setappdata(handles.rtthresh,<span class="string">'rt_y_outliers'</span>,out_rotat_idx_y);
0703 
0704 <span class="comment">%if composite measure</span>
0705 <span class="keyword">if</span> (get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0706     setappdata(handles.rtthresh,<span class="string">'rt_norm_outliers'</span>,[]);
0707     legend(handles.rotatGraph,<span class="string">'off'</span>);
0708     cla(handles.rotatGraph);
0709     set([handles.rotatGraph,handles.rt_up,handles.rt_down,handles.rtthresh,handles.text13],<span class="string">'visible'</span>,<span class="string">'off'</span>)
0710     set(handles.axes_mask,<span class="string">'position'</span>,get(handles.axes_mask,<span class="string">'position'</span>).*[1,1,1,0]+[0,0,0,.40]);
0711     set(handles.all_outliers,<span class="string">'position'</span>,get(handles.all_outliers,<span class="string">'position'</span>).*[1,1,1,0]+[0,0,0,.29]);
0712     <span class="keyword">return</span>
0713 <span class="keyword">end</span>
0714 set(handles.axes_mask,<span class="string">'position'</span>,get(handles.axes_mask,<span class="string">'position'</span>).*[1,1,1,0]+[0,0,0,.25]);
0715 set(handles.all_outliers,<span class="string">'position'</span>,get(handles.all_outliers,<span class="string">'position'</span>).*[1,1,1,0]+[0,0,0,.14]);
0716 
0717 axes(handles.rotatGraph);
0718 cla;
0719 plot(mv_data(:,4:6));
0720 set(gca,<span class="string">'xlim'</span>,[0,size(mv_data,1)+1]);
0721 l=ylabel(<span class="string">'rotation \newline  [rad]'</span>);
0722 set(l,<span class="string">'VerticalAlignment'</span>,<span class="string">'Bottom'</span>);
0723 set(gca,<span class="string">'XTickLabel'</span>,[]);
0724 legend(<span class="string">'pitch'</span>, <span class="string">'roll'</span>, <span class="string">'yaw'</span>, <span class="string">'Location'</span>, <span class="string">'East'</span>);
0725 h = gca;
0726 set(h,<span class="string">'Ygrid'</span>,<span class="string">'on'</span>);
0727 
0728 thresh_rt_x = 1:length(mv_data);
0729 thresh_rt_y = rotat_thresh*ones(1,length(mv_data));
0730 y_lim = get(gca, <span class="string">'YLim'</span>);
0731 line(thresh_rt_x, thresh_rt_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0732 line(thresh_rt_x, -1*thresh_rt_y, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0733 <span class="keyword">for</span> i = 1:length(out_rotat_idx_p)
0734     line((out_rotat_idx_p(i)*ones(1, 2)), y_lim, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0735 <span class="keyword">end</span>
0736 <span class="keyword">for</span> i = 1:length(out_rotat_idx_r)
0737     line((out_rotat_idx_r(i)*ones(1, 2)), y_lim, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0738 <span class="keyword">end</span>
0739 <span class="keyword">for</span> i = 1:length(out_rotat_idx_y)
0740     line((out_rotat_idx_y(i)*ones(1, 2)), y_lim, <span class="string">'Color'</span>, <span class="string">'black'</span>);
0741 <span class="keyword">end</span>
0742 set([h,handles.rt_up,handles.rt_down,handles.rtthresh,handles.text13],<span class="string">'visible'</span>,<span class="string">'on'</span>)
0743 <span class="keyword">end</span>
0744 
0745 
0746 <span class="comment">% -----------------------------------------------------------------------</span>
0747 <span class="comment">% UPDATESUMMARYPLOT</span>
0748 <span class="comment">% This function generates the summary plot (gui 1st plot from the top)</span>
0749 <span class="comment">% displaying the global signal and all of the identified outliers, and</span>
0750 <span class="comment">% optionally the design matrix information and corresponding breakdown of</span>
0751 <span class="comment">% outliers by condition</span>
0752 <span class="comment">% -----------------------------------------------------------------------</span>
0753 <a name="_sub5" href="#_subfunctions" class="code">function UpdateSummaryplot(hObject, eventdata, handles)</a>
0754 g = getappdata(handles.zthresh,<span class="string">'g'</span>);
0755 num_sess = length(g);
0756 tmps = get(handles.all_outliers,<span class="string">'String'</span>);
0757 <span class="keyword">if</span> ~isempty(tmps)
0758     nstrings = size(tmps,1);
0759     idx=cell(1,nstrings);
0760     <span class="keyword">for</span> i=1:nstrings
0761         idx{i}=round(str2num(tmps(i,:)));
0762     <span class="keyword">end</span>
0763     idx=cat(2,idx{:});
0764     set(handles.all_outliers, <span class="string">'String'</span>, int2str(idx));
0765 <span class="keyword">else</span>
0766     idx = [];
0767 <span class="keyword">end</span>
0768 
0769 <span class="comment">%plot global mean</span>
0770 axes(handles.globalMean);
0771 cla;
0772 <span class="comment">% BEGIN ohinds 2008-04-23: plot and print global mean</span>
0773 hold on;
0774 
0775 cur_sess_start=1;
0776 rng_mean=0;rng_minmax=[-inf,-inf];
0777 <span class="keyword">for</span> sess=1:num_sess
0778     <span class="comment">%rng{sess} = range(g{sess}(:,1));</span>
0779     rng_mean=rng_mean+mean(g{sess}(:,1));
0780     rng_minmax=max(rng_minmax,[-min(g{sess}(:,1)),max(g{sess}(:,1))]);
0781     plot(cur_sess_start:cur_sess_start+length(g{sess}(:,1))-1, g{sess}(:,1));
0782     <span class="comment">%ylabstr = sprintf('%s %f (%d)', ylabstr, rng{sess}, sess); % ohinds: can't put the range for all sessions on the ylabel, not enough room</span>
0783     cur_sess_start = cur_sess_start + length(g{sess}(:,1));
0784 <span class="keyword">end</span>
0785 set(gca,<span class="string">'xlim'</span>,[0,cur_sess_start]);<span class="comment">%,'ylim',rng_minmax.*[-1,1]);</span>
0786 rng_mean=rng_mean/num_sess;
0787 
0788 ylabel(<span class="string">'mean image\newlineintensity'</span>);
0789 xlabel(<span class="string">'scans'</span>);
0790 <span class="comment">% END ohinds 2008-04-23: plot global mean</span>
0791 
0792 y_lim = get(gca, <span class="string">'YLim'</span>);
0793 cur_sess_start=1;
0794 <span class="keyword">for</span> sess=1:num_sess
0795     patch(cur_sess_start+[0,0,(length(g{sess}(:,1))-1)*[1,1]],[ylim,fliplr(ylim)],-ones(1,4),.9+.05*rem(sess,2)*[1,1,1],<span class="string">'edgecolor'</span>,<span class="string">'none'</span>);
0796     <span class="keyword">if</span> num_sess&gt;1
0797         text(cur_sess_start+(length(g{sess}(:,1))-1)/2,ylim*[-.1;1.1],[<span class="string">'Session '</span>,num2str(sess)],<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
0798     <span class="keyword">end</span>
0799     cur_sess_start = cur_sess_start + length(g{sess}(:,1));
0800 <span class="keyword">end</span>
0801 <span class="keyword">for</span> i = 1:length(idx)
0802     line((idx(i)*ones(1, 2)), y_lim, <span class="string">'Color'</span>, <span class="string">'red'</span>);
0803 <span class="keyword">end</span>
0804 hold off;
0805 analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>);
0806 analyses.outliers.scans=idx;
0807 setappdata(handles.savefile,<span class="string">'analyses'</span>,analyses);
0808 
0809 <span class="comment">%show design (moved to global plot &lt;alfnie&gt; 2009-01)</span>
0810 <span class="keyword">if</span> (get(handles.showDesign,<span class="string">'Value'</span>) == get(handles.showDesign,<span class="string">'Max'</span>))
0811     [SPM,design,names] = <a href="#_sub35" class="code" title="subfunction [SPM,design,names] = get_design(handles)">get_design</a>(handles);
0812     stats_file=getappdata(handles.showDesign,<span class="string">'SPMfile'</span>);
0813     hold on
0814     colors = {<span class="string">'k:'</span>,<span class="string">'b:'</span>,<span class="string">'r:'</span>,<span class="string">'g:'</span>,<span class="string">'c:'</span>,<span class="string">'m:'</span>,<span class="string">'y:'</span>};
0815     h=plot(1,nan,<span class="string">'.'</span>,<span class="string">'markersize'</span>,1);
0816     <span class="keyword">for</span> i=1:size(design,2)
0817         h(i+1)=plot(1:size(design,1) , rng_mean+sum(rng_minmax)/2*design(:,i),colors{mod(i,5)+1},<span class="string">'MarkerSize'</span>,4);
0818     <span class="keyword">end</span>
0819     <span class="comment">% computes number of outliers per condition &lt;alfnie&gt; 2009-01</span>
0820     out_idx=round(idx(idx&gt;0));
0821     <span class="keyword">if</span> cur_sess_start-1~=size(design,1),
0822         disp([<span class="string">'warning: incorrect number of scans (design matrix: '</span>,num2str(size(design,1)),<span class="string">' ; functional data: '</span>,num2str(cur_sess_start-1),<span class="string">')'</span>]);
0823         outliers_per_condition=length(out_idx);
0824     <span class="keyword">else</span>
0825         outliers_per_condition=[length(out_idx),sum(abs(design(out_idx,:)&gt;0),1); size(design,1),sum(abs(design(:,:)&gt;0),1)];
0826     <span class="keyword">end</span>
0827     <span class="keyword">if</span> size(outliers_per_condition,2)==length(names)+1,
0828         legendnames={[<span class="string">'Total :'</span>,num2str(outliers_per_condition(1,1)),<span class="string">' outlier scans ('</span>,num2str(100*outliers_per_condition(1,1)/max(eps,outliers_per_condition(2,1)),<span class="string">'%0.0f'</span>),<span class="string">'%)'</span>]};
0829         <span class="keyword">for</span> i=1:length(names), legendnames{i+1}=[names{i},<span class="string">' :'</span>,num2str(outliers_per_condition(1,i+1),<span class="string">'%0.0f'</span>),<span class="string">' outlier scans ('</span>,num2str(100*outliers_per_condition(1,i+1)/max(eps,outliers_per_condition(2,i+1)),<span class="string">'%0.0f'</span>),<span class="string">'%)'</span>]; <span class="keyword">end</span>
0830         legend(h,legendnames{:});
0831     <span class="keyword">end</span>
0832     analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>);
0833     analyses.outliers.condition_effects=outliers_per_condition(1,2:end);
0834     analyses.outliers.condition_names=names;
0835     setappdata(handles.savefile,<span class="string">'analyses'</span>,analyses);
0836     [statsfile_path,statsfile_name] = fileparts(stats_file); <span class="keyword">if</span> isempty(statsfile_path),statsfile_path=pwd;<span class="keyword">end</span>;
0837     stats_file_outliers=fullfile(statsfile_path,[statsfile_name,<span class="string">'_outliers.txt'</span>]);
0838     <span class="keyword">if</span> ~isempty(stats_file_outliers)
0839         <span class="keyword">for</span> fpidx = 1:2,
0840             <span class="keyword">if</span> fpidx==1,
0841                 fp=1;
0842                 fprintf(<span class="string">'Number of outliers\n'</span>);
0843             <span class="keyword">else</span>
0844                 fp=fopen(stats_file_outliers,<span class="string">'w'</span>);
0845                 fprintf(<span class="string">'saving outlier statistics to %s\n'</span>,stats_file_outliers);
0846             <span class="keyword">end</span>
0847             <span class="keyword">if</span> fp ~= -1
0848                 fprintf(fp,<span class="string">'%10s '</span>,<span class="string">'Total'</span>);
0849                 fprintf(fp,<span class="string">'%10s '</span>,names{:});
0850                 fprintf(fp,<span class="string">'\n'</span>);
0851                 fprintf(fp,<span class="string">'%10.0f '</span>,outliers_per_condition(1,:));
0852                 fprintf(fp,<span class="string">'\n'</span>);
0853                 fprintf(fp,<span class="string">' %9.1f%%'</span>,100*outliers_per_condition(1,:)./max(eps,outliers_per_condition(2,:)));
0854                 fprintf(fp,<span class="string">'\n'</span>);
0855             <span class="keyword">end</span>
0856             <span class="keyword">if</span> fpidx&gt;1, fclose(fp); <span class="keyword">end</span>
0857         <span class="keyword">end</span>
0858     <span class="keyword">end</span>
0859     hold off
0860     
0861 <span class="keyword">else</span>
0862     legend off;
0863 <span class="keyword">end</span>
0864 <span class="keyword">if</span> (get(handles.showOptions,<span class="string">'Value'</span>) &gt; 1)
0865     <a href="#_sub12" class="code" title="subfunction showOptions_Callback(hObject, eventdata, handles, rescale_clim) ">showOptions_Callback</a>(hObject, eventdata, handles);
0866 <span class="keyword">else</span>
0867     <a href="#_sub12" class="code" title="subfunction showOptions_Callback(hObject, eventdata, handles, rescale_clim) ">showOptions_Callback</a>(hObject, eventdata, []);
0868 <span class="keyword">end</span>
0869 <span class="keyword">end</span>
0870 
0871 
0872 <span class="comment">% -----------------------------------------------------------------------</span>
0873 <span class="comment">% UNIONOUTLIERS</span>
0874 <span class="comment">% This function retrieves all of the outliers identified from the global</span>
0875 <span class="comment">% signal and movement parameters and updates the list of all outliers</span>
0876 <span class="comment">% -----------------------------------------------------------------------</span>
0877 <a name="_sub6" href="#_subfunctions" class="code">function UnionOutliers(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0878 
0879 <span class="comment">%get data</span>
0880 idx = getappdata(handles.zthresh,<span class="string">'zoutliers'</span>);
0881 <span class="keyword">if</span> ~(get(handles.norms,<span class="string">'Value'</span>) == get(handles.norms,<span class="string">'Max'</span>))
0882     idx = [idx , getappdata(handles.mvthresh,<span class="string">'mv_x_outliers'</span>)];
0883     idx = [idx , getappdata(handles.mvthresh,<span class="string">'mv_y_outliers'</span>)];
0884     idx = [idx , getappdata(handles.mvthresh,<span class="string">'mv_z_outliers'</span>)];
0885     idx = [idx , getappdata(handles.rtthresh,<span class="string">'rt_p_outliers'</span>)];
0886     idx = [idx , getappdata(handles.rtthresh,<span class="string">'rt_r_outliers'</span>)];
0887     idx = [idx , getappdata(handles.rtthresh,<span class="string">'rt_y_outliers'</span>)];
0888 <span class="keyword">else</span>
0889     idx = [idx , getappdata(handles.rtthresh,<span class="string">'rt_norm_outliers'</span>)];
0890     idx = [idx , getappdata(handles.mvthresh,<span class="string">'mv_norm_outliers'</span>)];
0891 <span class="keyword">end</span>
0892 idx = unique(idx);
0893 <span class="comment">%update data</span>
0894 set(handles.all_outliers, <span class="string">'String'</span>, int2str(idx));
0895 <span class="keyword">end</span>
0896 
0897 
0898 <span class="comment">% -----------------------------------------------------------------------</span>
0899 <span class="comment">% DIFFSGLOBALANDMOTION_CALLBACK</span>
0900 <span class="comment">% This function executes when any of the 'Use diff' checkboxes are toggled</span>
0901 <span class="comment">% It toggles between 'absolute' and 'scan-to-scan' measures for any of the</span>
0902 <span class="comment">% global signal or subject movement parameters, and update the</span>
0903 <span class="comment">% corresponding plots</span>
0904 <span class="comment">% -----------------------------------------------------------------------</span>
0905 <a name="_sub7" href="#_subfunctions" class="code">function diffsglobalandmotion_Callback(hObject, eventdata, handles,option_global,option_motion)</a>
0906 <span class="keyword">if</span> nargin&lt;4||isempty(option_global), option_global=0; <span class="keyword">end</span>
0907 <span class="keyword">if</span> nargin&lt;5||isempty(option_motion), option_motion=0; <span class="keyword">end</span>
0908 
0909 <span class="keyword">if</span> option_motion <span class="comment">% diff_motion</span>
0910     <span class="comment">%switch thresholds</span>
0911     tmp = get(handles.mvthresh,<span class="string">'String'</span>);
0912     set(handles.mvthresh,<span class="string">'String'</span>,getappdata(handles.mvthresh,<span class="string">'altval'</span>));
0913     setappdata(handles.mvthresh,<span class="string">'altval'</span>,tmp);
0914     tmp = get(handles.rtthresh,<span class="string">'String'</span>);
0915     set(handles.rtthresh,<span class="string">'String'</span>,getappdata(handles.rtthresh,<span class="string">'altval'</span>));
0916     setappdata(handles.rtthresh,<span class="string">'altval'</span>,tmp);
0917     
0918     <span class="comment">%switch data used</span>
0919     mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
0920     tmp = mv_data(:,1:6);
0921     mv_data(:,1:6) = mv_data(:,8:13);
0922     mv_data(:,8:13) = tmp;
0923     tmp = mv_data(:,14:32);
0924     mv_data(:,14:32) = mv_data(:,33:51);
0925     mv_data(:,33:51) = tmp;
0926     setappdata(handles.mvthresh,<span class="string">'mv_data'</span>,mv_data);
0927 <span class="keyword">end</span>
0928 
0929 <span class="keyword">if</span> option_global <span class="comment">%diff_global</span>
0930     g = getappdata(handles.zthresh,<span class="string">'g'</span>);
0931     <span class="keyword">for</span> n1=1:length(g), g{n1}(:,[2,4])=g{n1}(:,[4,2]); <span class="keyword">end</span>
0932     setappdata(handles.zthresh,<span class="string">'g'</span>,g);
0933 <span class="keyword">end</span>
0934 
0935 <span class="keyword">if</span> option_global
0936     <a href="#_sub2" class="code" title="subfunction UpdateGlobal(hObject, eventdata, handles, incr) ">UpdateGlobal</a>(hObject, eventdata, handles,1.0);
0937 <span class="keyword">end</span>
0938 <span class="keyword">if</span> option_motion
0939     <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,1.0);
0940     <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,1.0);
0941 <span class="keyword">end</span>
0942 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
0943 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
0944 <span class="keyword">end</span>
0945 
0946 
0947 <span class="comment">% -----------------------------------------------------------------------</span>
0948 <span class="comment">% SHOWCORR_CALLBACK</span>
0949 <span class="comment">% Computes and displays the movement-task correlations</span>
0950 <span class="comment">% -----------------------------------------------------------------------</span>
0951 <a name="_sub8" href="#_subfunctions" class="code">function showCorr_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
0952 <span class="keyword">if</span> 1 <span class="comment">%(get(handles.showCorr,'Value') == get(handles.showCorr,'Max'))</span>
0953     <span class="comment">%display correlations</span>
0954     [SPM,design,names] = <a href="#_sub35" class="code" title="subfunction [SPM,design,names] = get_design(handles)">get_design</a>(handles);
0955     mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
0956     sessions = getappdata(handles.showDesign,<span class="string">'sessions'</span>);
0957     f = figure;
0958     setappdata(handles.showCorr,<span class="string">'figure'</span>,f);
0959     nrows=zeros(1,length(sessions)+1);
0960     cm=cell(1,length(sessions));
0961     cm_tmp=cell(1,length(sessions));
0962     <span class="keyword">for</span> sess=1:length(sessions),
0963         s = sessions(sess);
0964         rows = SPM.Sess(s).row;
0965         cols = SPM.Sess(s).col(1:length(SPM.Sess(s).U)); <span class="comment">% extracts only effects of interest (no covariates) from design matrix</span>
0966         nrows(sess+1)=length(rows);
0967         
0968         <span class="comment">%create partial matrix to correlate (we only want to correlate with the motion parameters within each session). NOTE: This may cause weird behaviour in weird designs... (note: author please clarify)</span>
0969         part = [SPM.xX.X(rows,cols) mv_data(sum(nrows(1:sess))+(1:nrows(sess+1)),1:6)];
0970         cm{sess} = corrcoef(part);
0971         a = subplot(length(sessions),1,sess);
0972         
0973         imagesc(cm{sess}(1:end-6,end-5:end),[-1,1]);
0974         cm_tmp{sess} = cm{sess}(1:end-6,end-5:end);
0975         colorbar;
0976         xlabel_names{sess} = {<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'pitch'</span>,<span class="string">'roll'</span>,<span class="string">'yaw'</span>};
0977         ylabel_names{sess} = names;
0978         set(a,<span class="string">'XTickLabel'</span>,{<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'pitch'</span>,<span class="string">'roll'</span>,<span class="string">'yaw'</span>});
0979         set(a,<span class="string">'YTick'</span>,1:length(cols));
0980         set(a,<span class="string">'YTickLabel'</span>,names);
0981         title(sprintf(<span class="string">'Session %d'</span>,s));
0982         analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>);
0983         analyses.motion_task_correlation(sess)=struct(<span class="string">'r'</span>,cm{sess}(1:end-6,end-5:end),<span class="string">'rows'</span>,{get(a,<span class="string">'yticklabel'</span>)},<span class="string">'cols'</span>,{get(a,<span class="string">'xticklabel'</span>)});
0984         setappdata(handles.savefile,<span class="string">'analyses'</span>,analyses);
0985         
0986     <span class="keyword">end</span>
0987     f = getappdata(handles.showCorr,<span class="string">'figure'</span>);
0988     set( f, <span class="string">'units'</span>, <span class="string">'normalized'</span>, <span class="string">'outerposition'</span>, [ 0 0 1 1], <span class="string">'paperpositionmode'</span>, <span class="string">'auto'</span> );
0989     output_dir = getappdata(handles.savefile,<span class="string">'dir'</span>);
0990     saveas( f, fullfile( output_dir, <span class="string">'motion_task_correlation.fig'</span>) );
0991     saveas( f, fullfile( output_dir, <span class="string">'motion_task_correlation.png'</span>) );
0992     cm = cm_tmp;
0993     save( fullfile( output_dir, <span class="string">'motion_task_correlation.mat'</span>), <span class="string">'cm'</span>, <span class="string">'xlabel_names'</span>, <span class="string">'ylabel_names'</span>);
0994 <span class="keyword">else</span>
0995     f = getappdata(handles.showCorr,<span class="string">'figure'</span>);
0996     <span class="keyword">if</span> ishandle(f)
0997         close(f);
0998     <span class="keyword">end</span>
0999 <span class="keyword">end</span>
1000 <span class="keyword">end</span>
1001 
1002 <span class="comment">% -----------------------------------------------------------------------</span>
1003 <span class="comment">% SHOW_SIGNAL_CORR_CALLBACK</span>
1004 <span class="comment">% Computes and displays the BOLD signal-task correlations</span>
1005 <span class="comment">% -----------------------------------------------------------------------</span>
1006 <a name="_sub9" href="#_subfunctions" class="code">function show_signal_corr_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
1007 <span class="keyword">if</span> 1 <span class="comment">%(get(handles.sigCorr,'Value') == get(handles.sigCorr,'Max'))</span>
1008     <span class="comment">%display correlations</span>
1009     SPM = <a href="#_sub35" class="code" title="subfunction [SPM,design,names] = get_design(handles)">get_design</a>(handles);
1010     g = getappdata(handles.zthresh,<span class="string">'g'</span>);
1011     sessions = getappdata(handles.showDesign,<span class="string">'sessions'</span>);
1012     f = figure;
1013     setappdata(handles.sigCorr,<span class="string">'figure'</span>,f);
1014     cm=cell(1,length(sessions));
1015     cm_tmp=cell(1,length(sessions));
1016     <span class="keyword">for</span> sess=1:length(sessions)
1017         s = sessions(sess);
1018         rows = SPM.Sess(s).row;
1019         cols = SPM.Sess(s).col(1:length(SPM.Sess(s).U)); <span class="comment">% extracts only effects of interest (no covariates) from design matrix</span>
1020         
1021         <span class="comment">%create partial matrix to correlate (we only want to correlate with the motion parameters within each session). NOTE: This may cause weird behaviour in weird designs... (note: author please clarify)</span>
1022         part = [SPM.xX.X(rows,cols) g{sess}(:,1)];
1023         cm{sess} = corrcoef(part);
1024         a = subplot(length(sessions),1,sess);
1025         
1026         imagesc(cm{sess}(end:<span class="keyword">end</span>,1:end-1),[-1,1]);
1027         cm_tmp{sess} = cm{sess}(end:<span class="keyword">end</span>,1:end-1);
1028         colorbar;
1029         names=cat(2,SPM.Sess(s).U(1:length(cols)).name);
1030         xlabel_names{sess} = names;
1031         ylabel_names{sess} = <span class="string">'mean_activation'</span>;
1032         set(a,<span class="string">'XTick'</span>,1:length(cols));
1033         set(a,<span class="string">'XTickLabel'</span>,names);
1034         set(a,<span class="string">'YTick'</span>,1);
1035         set(a,<span class="string">'YTickLabel'</span>,<span class="string">'mean activation'</span>);
1036         title(sprintf(<span class="string">'Session %d'</span>,s));
1037         analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>);
1038         analyses.signal_task_correlation(sess)=struct(<span class="string">'r'</span>,cm{sess}(<span class="keyword">end</span>,1:end-1),<span class="string">'rows'</span>,{get(a,<span class="string">'yticklabel'</span>)},<span class="string">'cols'</span>,{get(a,<span class="string">'xticklabel'</span>)});
1039         setappdata(handles.savefile,<span class="string">'analyses'</span>,analyses);
1040     <span class="keyword">end</span>
1041     f = getappdata(handles.sigCorr,<span class="string">'figure'</span>);
1042     set( f,<span class="string">'units'</span>,<span class="string">'normalized'</span>,<span class="string">'outerposition'</span>,[0 0 1 1],<span class="string">'PaperPositionMode'</span>, <span class="string">'auto'</span> )
1043     output_dir = getappdata(handles.savefile,<span class="string">'dir'</span>);
1044     saveas( f, fullfile( output_dir, <span class="string">'global_signal_task_correlation.fig'</span>) );
1045     saveas( f, fullfile( output_dir, <span class="string">'global_signal_task_correlation.png'</span>) );
1046     cm = cm_tmp;
1047     
1048     save( fullfile( output_dir, <span class="string">'global_signal_task_correlation.mat'</span>), <span class="string">'cm'</span>, <span class="string">'xlabel_names'</span>, <span class="string">'ylabel_names'</span> );
1049 <span class="keyword">else</span>
1050     f = getappdata(handles.sigCorr,<span class="string">'figure'</span>);
1051     <span class="keyword">if</span> ishandle(f)
1052         close(f);
1053     <span class="keyword">end</span>
1054 <span class="keyword">end</span>
1055 <span class="keyword">end</span>
1056 
1057 <span class="comment">% -----------------------------------------------------------------------</span>
1058 <span class="comment">% SHOWSPEC_CALLBACK</span>
1059 <span class="comment">% Computes and displays the spectrum of BOLD signal, movement, and task</span>
1060 <span class="comment">% regressors</span>
1061 <span class="comment">% -----------------------------------------------------------------------</span>
1062 <a name="_sub10" href="#_subfunctions" class="code">function showSpec_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
1063 <span class="keyword">if</span> (get(handles.showSpec,<span class="string">'Value'</span>) == get(handles.showSpec,<span class="string">'Max'</span>))
1064     <span class="comment">%get data and compute power spectrum</span>
1065     SPM = <a href="#_sub35" class="code" title="subfunction [SPM,design,names] = get_design(handles)">get_design</a>(handles);
1066     mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
1067     g = getappdata(handles.zthresh,<span class="string">'g'</span>);
1068     sessions = getappdata(handles.showDesign,<span class="string">'sessions'</span>);
1069     f = figure;
1070     setappdata(handles.showSpec,<span class="string">'figure'</span>,f);
1071     
1072     <span class="comment">%sampling freq.</span>
1073     sf = 1/SPM.xY.RT;
1074     
1075     nrows=zeros(1,length(sessions)+1);
1076     <span class="keyword">for</span> sess=1:length(sessions),
1077         s = sessions(sess);
1078         rows = SPM.Sess(s).row;
1079         cols = SPM.Sess(s).col(1:length(SPM.Sess(s).U)); <span class="comment">% extracts only effects of interest (no covariates) from design matrix</span>
1080         nrows(sess+1)=length(rows);
1081         
1082         <span class="comment">%create partial design matrix which only contains relevant data</span>
1083         <span class="comment">%for curent session</span>
1084         data = [SPM.xX.X(rows,cols),mv_data(sum(nrows(1:sess))+(1:nrows(sess+1)),1:6),g{sess}(:,1)]; <span class="comment">%alfnie 08/2009: added global signal</span>
1085         
1086         cf = sf/2; <span class="comment">%Nyquist freq.</span>
1087         n = size(data,1);
1088         
1089         <span class="comment">%this is done in a loop (and not in matrix ops) since dct encounters memory problems for large matrices.</span>
1090         hold on
1091         n=n*5;freqs = (0:cf/n:cf-cf/n)';f = zeros(5*size(data,1),size(data,2));F=f;<span class="comment">%alfnie 08/2009: resample</span>
1092         <span class="keyword">for</span> i=1:size(data,2)
1093             <span class="comment">%%calculate dct</span>
1094             temp=(abs(fft(detrend(data(:,i)).*<a href="#_sub43" class="code" title="subfunction w=hanning(n)">hanning</a>(size(data,1)),2*5*size(data,1))).^2);<span class="comment">%alfnie 08/2009: plot spectral densities</span>
1095             f(:,i) = temp(1:end/2);
1096             <span class="comment">%normalize</span>
1097             F(:,i) = f(:,i)/(sum(abs(f(:,i))./freqs([2,2:end])));F(1,i)=nan; <span class="comment">% normalization (plots show same area in log-freq space)</span>
1098         <span class="keyword">end</span>
1099         
1100         a = subplot(length(sessions), 1, sess);
1101         hs = plot(freqs,F,<span class="string">'-'</span>); axis tight; set(gca,<span class="string">'xlim'</span>,[sf/size(data,1),cf],<span class="string">'xscale'</span>,<span class="string">'log'</span>,<span class="string">'yscale'</span>,<span class="string">'lin'</span>);set(gcf,<span class="string">'color'</span>,<span class="string">'w'</span>);<span class="comment">%.9412*[1,1,1])</span>
1102         names=cat(2,SPM.Sess(s).U(1:length(cols)).name);
1103         names(end+1:end+7) = {<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'pitch'</span>,<span class="string">'roll'</span>,<span class="string">'yaw'</span>,<span class="string">'BOLD'</span>};
1104         l = legend(names,<span class="string">'Location'</span>,<span class="string">'EastOutside'</span>);
1105         pos = get(l,<span class="string">'Position'</span>);
1106         set(l,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
1107         
1108         
1109         <span class="keyword">for</span> i = 1:length(names)
1110             color = get(hs(i),<span class="string">'Color'</span>);
1111             box = uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="string">'String'</span>,names(i),<span class="string">'ForegroundColor'</span>, color,<span class="string">'backgroundcolor'</span>,<span class="string">'w'</span>,<span class="string">'Callback'</span>,{@<a href="#_sub11" class="code" title="subfunction showSpec_Callback_setvisibility(handle,tmp) ">showSpec_Callback_setvisibility</a>},<span class="string">'Value'</span>,1,<span class="string">'UserData'</span>,hs(i),<span class="string">'Units'</span>,<span class="string">'normalized'</span>);
1112             tmppos = get(box,<span class="string">'Position'</span>);
1113             tmppos(1:2) = pos(1:2);
1114             tmppos(3)=1-tmppos(1);
1115             set(box,<span class="string">'Position'</span>,tmppos);
1116             pos(2) = pos(2)+ 0.035;
1117             <span class="keyword">if</span> (i &gt; length(names)-7)&amp;&amp;i&lt;length(names)
1118                 set(box,<span class="string">'Value'</span>,0);
1119                 <a href="#_sub11" class="code" title="subfunction showSpec_Callback_setvisibility(handle,tmp) ">showSpec_Callback_setvisibility</a>(box,0);
1120             <span class="keyword">end</span>
1121         <span class="keyword">end</span>
1122         
1123         title(sprintf(<span class="string">'Session %d'</span>,s));
1124         ylabel(<span class="string">'Power density (normalized)'</span>);
1125         <span class="comment">%try finding highpass freq. in SPM.xX.K(s).Hparam</span>
1126         <span class="keyword">try</span>
1127             cutoff = 1/SPM.xX.K(s).HParam;
1128         <span class="keyword">catch</span>
1129             fprintf(<span class="string">'no highpass cutoff frequency found in SPM.mat, using default (128).\n'</span>);
1130             cutoff = 1/128;
1131         <span class="keyword">end</span>
1132         <span class="comment">%draw cutoff freq. DRG (2009-08-25) added to show cutoff frequency more clearly</span>
1133         x_lim = xlim(a);
1134         l = patch([x_lim(1) x_lim(1) cutoff cutoff],[ylim(a) fliplr(ylim(a))],-ones(1,4),[.8 .8 .8],<span class="string">'edgecolor'</span>,<span class="string">'none'</span>);
1135         xlabel(sprintf(<span class="string">'Frequency [Hz], cutoff=1/%i'</span>,1/cutoff));<span class="comment">%DRG (2009-08-25) This line was moved from ~15 lines up.</span>
1136         set(a,<span class="string">'UserData'</span>,l);
1137         
1138         analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>);
1139         analyses.motion_task_spectra(sess)=struct(<span class="string">'Power'</span>,f,<span class="string">'rows'</span>,freqs,<span class="string">'cols'</span>,{names});
1140         setappdata(handles.savefile,<span class="string">'analyses'</span>,analyses);
1141         
1142     <span class="keyword">end</span>
1143     
1144     set( gcf, <span class="string">'units'</span>, <span class="string">'normalized'</span>, <span class="string">'outerposition'</span>, [ 0 0 1 1], <span class="string">'paperpositionmode'</span>, <span class="string">'auto'</span> );
1145     output_dir = getappdata(handles.savefile,<span class="string">'dir'</span>);
1146     saveas( gcf, fullfile( output_dir, <span class="string">'task_spectra.fig'</span>) );
1147     saveas( gcf, fullfile( output_dir, <span class="string">'task_spectra.png'</span>) );
1148 
1149     
1150 <span class="keyword">else</span>
1151     f = getappdata(handles.showSpec,<span class="string">'figure'</span>);
1152     <span class="keyword">if</span> ishandle(f)
1153         close(f);
1154     <span class="keyword">end</span>
1155 <span class="keyword">end</span>
1156 <span class="keyword">end</span>
1157 
1158 <span class="comment">%toggle visibility for spectrum graph</span>
1159 <a name="_sub11" href="#_subfunctions" class="code">function showSpec_Callback_setvisibility(handle,tmp) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1160 h = get(handle,<span class="string">'UserData'</span>);
1161 <span class="keyword">if</span> (get(handle,<span class="string">'Value'</span>) == get(handle,<span class="string">'Max'</span>))
1162     set(h(1),<span class="string">'Visible'</span>,<span class="string">'on'</span>);
1163 <span class="keyword">else</span>
1164     set(h(1),<span class="string">'Visible'</span>,<span class="string">'off'</span>);
1165 <span class="keyword">end</span>
1166 <span class="comment">% DRG (2009-08-25) DON'T NEED TO DO THIS. LIMITS ARE ALWAYS THIS SAME ANYWAYS BECAUSE DATA IS THERE, BUT JUST HIDDEN. redraw the cutoff: a = ancestor(h(1),'axes');l = get(a,'UserData');set(l,'Visible','off');ylim = get(a,'YLim');set(l,'YData',ylim,'Visible','on');</span>
1167 <span class="keyword">end</span>
1168 
1169 <span class="comment">% -----------------------------------------------------------------------</span>
1170 <span class="comment">% SHOWOPTIONS_CALLBACK</span>
1171 <span class="comment">% Computes and displays the analysis mask, voxel-wise variance and SNR,</span>
1172 <span class="comment">% based on current list of outliers</span>
1173 <span class="comment">% -----------------------------------------------------------------------</span>
1174 <a name="_sub12" href="#_subfunctions" class="code">function showOptions_Callback(hObject, eventdata, handles, rescale_clim) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
1175 <span class="keyword">persistent</span> plotdata
1176 <span class="keyword">if</span> isempty(handles), <span class="keyword">return</span>; <span class="keyword">end</span>
1177 <span class="keyword">if</span> isempty(plotdata)||~isfield(plotdata,<span class="string">'figurehandle'</span>)||~isequal(plotdata.figurehandle,handles.figure1), <span class="comment">% note: keeps only one file at a time in memory (to speed up processing while working on the same art project, while avoiding running out of memory when having too many art windows open)</span>
1178     output_dir=getappdata(handles.savefile,<span class="string">'dir'</span>);
1179     art_mask_temporalfile=getappdata(handles.savefile,<span class="string">'art_mask_temporalfile'</span>);
1180     plotdata=load(fullfile(output_dir,art_mask_temporalfile));<span class="comment">%,'maskscan','VY1','VY','notcoregistered','xyz','Data_Sum','Data_SumSquared');</span>
1181     plotdata.Ma=spm_read_vols(plotdata.VY1);
1182     plotdata.Ma=plotdata.Ma/max(plotdata.Ma(:));
1183     plotdata.figurehandle=handles.figure1;
1184     temp=plotdata.VY1.mat(1:3,1:3);
1185     dir_order=zeros(1,3);
1186     [nill,dir_order(3)]=max(abs(temp(3,:)));dir_order(3)=dir_order(3)*sign(temp(3,dir_order(3)));
1187     [nill,dir_order(1)]=max(abs(temp(1,:)).*((1:3)~=dir_order(3)));dir_order(1)=dir_order(1)*sign(temp(1,dir_order(1)));
1188     dir_order(2)=setdiff(1:3,abs(dir_order([1,3]))); dir_order(2)=dir_order(2)*sign(temp(2,dir_order(2)));
1189     plotdata.dirorder=dir_order; <span class="comment">% directions of storage dimensions most similar to spatial directions (x,y,z)</span>
1190     first=1;
1191 <span class="keyword">else</span>
1192     first=0;
1193 <span class="keyword">end</span>
1194 <span class="keyword">if</span> nargin&lt;4, rescale_clim=0; <span class="keyword">end</span>
1195 
1196 <span class="keyword">if</span> isempty(handles)||get(handles.showOptions,<span class="string">'Value'</span>)==1,<span class="keyword">if</span> ~isempty(handles),set([handles.axes_mask;get(handles.axes_mask,<span class="string">'children'</span>)],<span class="string">'visible'</span>,<span class="string">'off'</span>); set([handles.text_all_outliers,handles.all_outliers],<span class="string">'visible'</span>,<span class="string">'on'</span>); <span class="keyword">end</span>; <span class="keyword">return</span>;
1197 <span class="keyword">elseif</span> strcmp(get(handles.axes_mask,<span class="string">'visible'</span>),<span class="string">'off'</span>), set(get(handles.axes_mask,<span class="string">'children'</span>),<span class="string">'visible'</span>,<span class="string">'on'</span>); set([handles.axes_mask,handles.text_all_outliers,handles.all_outliers],<span class="string">'visible'</span>,<span class="string">'off'</span>); <span class="keyword">end</span>
1198 option=get(handles.showOptions,<span class="string">'value'</span>);
1199 <span class="keyword">if</span> first, temp=get(handles.axes_mask,<span class="string">'children'</span>); delete(temp(ishandle(temp))); <span class="keyword">end</span>
1200 
1201 <span class="comment">% computes analysis mask</span>
1202 out_idx=round(str2num(get(handles.all_outliers, <span class="string">'String'</span>)));
1203 Mask=ones(plotdata.VY1.dim);
1204 <span class="keyword">for</span> n1=setdiff(1:length(plotdata.maskscan),out_idx),Mask(plotdata.maskscan{n1})=0;<span class="keyword">end</span>
1205 
1206 <span class="keyword">if</span> option&gt;2
1207     <span class="comment">% computes Var/SNR</span>
1208     <span class="keyword">if</span> numel(out_idx)&gt;100, hw=waitbar(0,<span class="string">'updating Variance/SNR plots. Please wait'</span>); <span class="keyword">end</span>
1209     N=numel(plotdata.VY);
1210     Data_Sum=plotdata.Data_Sum;
1211     Data_SumSquared=plotdata.Data_SumSquared;
1212     <span class="keyword">for</span> n1=1:numel(out_idx),
1213         i=out_idx(n1);
1214         <span class="keyword">if</span> plotdata.notcoregistered, temp=spm_get_data(plotdata.VY(i),pinv(plotdata.VY(i).mat)*plotdata.xyz);
1215         <span class="keyword">else</span> temp=reshape(spm_get_data(plotdata.VY(i),plotdata.xyz_voxel),plotdata.VY(i).dim); <span class="keyword">end</span>; <span class="comment">%temp=spm_read_vols(plotdata.VY(i)); end</span>
1216         Data_Sum=Data_Sum-temp;
1217         Data_SumSquared=Data_SumSquared-temp.^2;
1218         <span class="keyword">if</span> numel(out_idx)&gt;100, waitbar(n1/numel(out_idx),hw); <span class="keyword">end</span>
1219     <span class="keyword">end</span>
1220     Data_Sum=Data_Sum/max(eps,N-numel(out_idx));
1221     Data_SumSquared=Data_SumSquared/max(eps,N-numel(out_idx));
1222     Data_Std=reshape(sqrt(max(0,Data_SumSquared-Data_Sum.^2)),plotdata.VY1.dim)*(N-numel(out_idx))/max(eps,N-numel(out_idx)-1);
1223     Data_SNR=Data_Sum./max(eps,Data_Std);
1224     <span class="keyword">if</span> numel(out_idx)&gt;100, close(hw); <span class="keyword">end</span>
1225 <span class="keyword">end</span>
1226 
1227 <span class="keyword">switch</span>(option)
1228     <span class="keyword">case</span> 2, b=Mask.*(1+plotdata.Ma);cscale=nan;
1229     <span class="keyword">case</span> 3, b=Mask.*Data_Std; cscale=max(b(:)); 
1230     <span class="keyword">case</span> 4, b=Mask.*Data_SNR; cscale=max(b(:)); 
1231 <span class="keyword">end</span>
1232 
1233 <span class="comment">% generates display</span>
1234 b=permute(b,abs(plotdata.dirorder));
1235 <span class="keyword">for</span> n1=1:3,<span class="keyword">if</span> plotdata.dirorder(n1)&lt;0, b=b(end:-1:1,:,:); <span class="keyword">end</span>; b=permute(b,[2,3,1]); <span class="keyword">end</span>; <span class="comment">% turn to ~spatial (xyz)</span>
1236 b=permute(b(:,end:-1:1,:),[2,1,3]);
1237 sb=any(any(b,1),2);
1238 b=b(:,:,sb);
1239 slices=1:size(b,3);
1240 set(handles.axes_mask,<span class="string">'units'</span>,<span class="string">'points'</span>);
1241 size1=get(handles.axes_mask,<span class="string">'position'</span>);
1242 set(handles.axes_mask,<span class="string">'units'</span>,<span class="string">'normalized'</span>);
1243 size1=(size1(3)/size(b,2))/(size1(4)/size(b,1));
1244   nhoriz=1:length(slices);
1245   nverti=ceil(length(slices)./nhoriz);
1246   area=(min(size1./nhoriz,1./nverti).^2);  
1247 [nill,nhoriz]=max(area);
1248 temp=reshape(b(:,:,slices),[size(b,1),size(b,2)*length(slices)]);
1249 temp2=[];
1250 <span class="keyword">for</span> n1=1:ceil(length(slices)/nhoriz),
1251     temp2=cat(1,temp2,[temp(:,size(b,2)*(n1-1)*nhoriz+1:size(b,2)*min(n1*nhoriz,length(slices))),zeros(size(b,1),max(0,size(b,2)*(n1*nhoriz-length(slices))))]);
1252 <span class="keyword">end</span>
1253 <span class="keyword">if</span> isnan(cscale),
1254     temp2=[temp2,zeros(size(temp2,1),20)];
1255 <span class="keyword">else</span>
1256     temp2=[temp2,zeros(size(temp2,1),10),linspace(cscale,0,size(temp2,1))'*ones(1,10)];
1257 <span class="keyword">end</span>
1258 <span class="keyword">if</span> first||~isfield(plotdata,<span class="string">'h'</span>)||~ishandle(plotdata.h),
1259     axes(handles.axes_mask);
1260     plotdata.h=imagesc(-temp2,<span class="string">'parent'</span>,handles.axes_mask);
1261     colormap(handles.axes_mask,gray);
1262     <span class="keyword">if</span> isnan(cscale), set(handles.axes_mask,<span class="string">'clim'</span>,[-2,0],<span class="string">'ytick'</span>,[],<span class="string">'visible'</span>,<span class="string">'off'</span>); 
1263     <span class="keyword">else</span> set(handles.axes_mask,<span class="string">'ytick'</span>,1,<span class="string">'yticklabel'</span>,{num2str(cscale,<span class="string">'%0.1f'</span>)},<span class="string">'visible'</span>,<span class="string">'on'</span>); <span class="keyword">end</span>
1264     set(handles.axes_mask,<span class="string">'xtick'</span>,[],<span class="string">'xcolor'</span>,<span class="string">'w'</span>,<span class="string">'yaxislocation'</span>,<span class="string">'right'</span>,<span class="string">'box'</span>,<span class="string">'off'</span>);
1265     axis(handles.axes_mask,<span class="string">'equal'</span>,<span class="string">'tight'</span>);
1266     <span class="keyword">if</span> option==3, plotdata.h2=text(size(temp2,2)+8,size(temp2,1)/2,<span class="string">'standard deviation'</span>,<span class="string">'rotation'</span>,90,<span class="string">'fontsize'</span>,8,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
1267     <span class="keyword">elseif</span> option==4, plotdata.h2=text(size(temp2,2)+8,size(temp2,1)/2,<span class="string">'SNR'</span>,<span class="string">'rotation'</span>,90,<span class="string">'fontsize'</span>,8,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
1268     <span class="keyword">else</span> plotdata.h2=text(size(temp2,2)+8,size(temp2,1)/2,<span class="string">''</span>,<span class="string">'rotation'</span>,90,<span class="string">'fontsize'</span>,8,<span class="string">'horizontalalignment'</span>,<span class="string">'center'</span>);
1269     <span class="keyword">end</span>
1270 <span class="keyword">else</span>
1271     set(plotdata.h,<span class="string">'cdata'</span>,-temp2);
1272     <span class="keyword">if</span> isnan(cscale), set(handles.axes_mask,<span class="string">'clim'</span>,[-2,0],<span class="string">'ytick'</span>,[],<span class="string">'visible'</span>,<span class="string">'off'</span>); <span class="keyword">end</span>
1273     <span class="keyword">if</span> ~isnan(cscale)&amp;&amp;rescale_clim, set(handles.axes_mask,<span class="string">'clim'</span>,[-cscale,0],<span class="string">'ytick'</span>,1,<span class="string">'yticklabel'</span>,{num2str(cscale,<span class="string">'%0.1f'</span>)},<span class="string">'visible'</span>,<span class="string">'on'</span>); <span class="keyword">end</span>
1274     axis(handles.axes_mask,<span class="string">'equal'</span>,<span class="string">'tight'</span>);
1275     <span class="keyword">if</span> option==3, set(plotdata.h2,<span class="string">'string'</span>,<span class="string">'standard deviation'</span>);
1276     <span class="keyword">elseif</span> option==4, set(plotdata.h2,<span class="string">'string'</span>,<span class="string">'SNR'</span>);
1277     <span class="keyword">else</span> set(plotdata.h2,<span class="string">'string'</span>,<span class="string">''</span>);
1278     <span class="keyword">end</span>
1279     set(plotdata.h2,<span class="string">'position'</span>,[size(temp2,2)+8,size(temp2,1)/2,0]);
1280 <span class="keyword">end</span>
1281 <span class="keyword">end</span>
1282 
1283 
1284 <span class="comment">% -----------------------------------------------------------------------</span>
1285 <span class="comment">% SAVEFILE_CALLBACK</span>
1286 <span class="comment">% Saves art output files (motion statistics, graphs, SPM regressors, or</span>
1287 <span class="comment">% Analysis mask)</span>
1288 <span class="comment">% -----------------------------------------------------------------------</span>
1289 <a name="_sub13" href="#_subfunctions" class="code">function savefile_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
1290 
1291 <span class="comment">% [S,v] = listdlg('PromptString','What would you like to save?',...</span>
1292 <span class="comment">%     'SelectionMode','multiple',...</span>
1293 <span class="comment">%     'ListSize',[160,120], ...</span>
1294 <span class="comment">%     'ListString',{'Outliers','Motion Statistics','Graphs','SPM regressors','Analysis mask','Voxel-wise Variability','Voxel-wise SNR'});</span>
1295 S = 1:7;
1296 v = 1;
1297 <span class="keyword">if</span> v==0
1298     <span class="keyword">return</span>;
1299 <span class="keyword">end</span>
1300 <span class="comment">%get path</span>
1301 tmpdir = pwd;
1302 pathname = <span class="string">'.'</span>; <span class="comment">%getappdata(hObject, 'path');</span>
1303 cd(pathname);
1304 <span class="keyword">for</span> s=S(:)',
1305     <span class="keyword">switch</span> s
1306         <span class="keyword">case</span> 1 <span class="comment">%save outliers</span>
1307             out_idx = round(str2num(get(handles.all_outliers, <span class="string">'String'</span>))); <span class="comment">%#ok&lt;NASGU&gt;</span>
1308             
1309             output_dir = getappdata(handles.savefile,<span class="string">'dir'</span>);
1310             save( fullfile( output_dir, <span class="string">'outliers.txt'</span>), <span class="string">'out_idx'</span>, <span class="string">'-ascii'</span> );
1311             
1312             <span class="keyword">if</span> 0
1313                 <span class="comment">%ask user to choose filename</span>
1314                 filter = {<span class="string">'*.mat'</span>;<span class="string">'*.txt'</span>};
1315                 <span class="comment">%ext = {'.mat';'.txt'};</span>
1316                 [filename, pathname, filteridx] = uiputfile( filter,<span class="string">'Save outliers as:'</span>);
1317                 
1318                 <span class="comment">%save according to file format</span>
1319                 <span class="keyword">switch</span> filteridx
1320                     <span class="comment">%binary MAT file</span>
1321                     <span class="keyword">case</span> 1
1322                         filename = strcat(char(pathname), char(filename));
1323                         save(filename ,<span class="string">'out_idx'</span>, <span class="string">'-mat'</span>);
1324                         <span class="comment">%txt file</span>
1325                     <span class="keyword">case</span> 2
1326                         filename = strcat(char(pathname), char(filename));
1327                         save(filename,<span class="string">'out_idx'</span>,<span class="string">'-ascii'</span>);
1328                 <span class="keyword">end</span>
1329             <span class="keyword">end</span>
1330         <span class="keyword">case</span> 2 <span class="comment">%save motion statistics</span>
1331             mv_stats = getappdata(handles.mvthresh,<span class="string">'mv_stats'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1332             analyses=getappdata(handles.savefile,<span class="string">'analyses'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1333             
1334             
1335             save(fullfile( output_dir, <span class="string">'mov_stats.mat'</span>),<span class="string">'mv_stats'</span>,<span class="string">'analyses'</span>,<span class="string">'-mat'</span>);
1336             
1337             <span class="keyword">if</span> 0
1338                 <span class="comment">%save statistics to .mat file</span>
1339                 <span class="comment">%mv_stats has 7 columns corresponding to x y z pitch roll yaw norm</span>
1340                 <span class="comment">%and 3 rows corresponding to mean, stdv and max of the absolute values of</span>
1341                 <span class="comment">%the movement parameters</span>
1342                 
1343                 <span class="comment">%ask user to choose filename</span>
1344                 filter = {<span class="string">'*.mat'</span>; <span class="string">'*.txt'</span>};
1345                 [filename, pathname, filteridx] = uiputfile( filter,<span class="string">'Save motion statistics as'</span>);
1346                 
1347                 <span class="comment">%save according to file format</span>
1348                 <span class="keyword">switch</span> filteridx
1349                     <span class="keyword">case</span> 1 <span class="comment">%binary MAT file</span>
1350                         filename = strcat(char(pathname), char(filename));
1351                         save(filename ,<span class="string">'mv_stats'</span>,<span class="string">'analyses'</span>,<span class="string">'-mat'</span>);
1352                     <span class="keyword">case</span> 2 <span class="comment">%txt file</span>
1353                         filename = strcat(char(pathname), char(filename));
1354                         save(filename,<span class="string">'mv_stats'</span>,<span class="string">'analyses'</span>,<span class="string">'-ascii'</span>);
1355                 <span class="keyword">end</span>
1356             <span class="keyword">end</span>
1357         <span class="keyword">case</span> 3 <span class="comment">%save graphs</span>
1358             
1359             <span class="keyword">if</span> 0
1360                 <span class="comment">%ask user to choose filename</span>
1361             filter = {<span class="string">'*.jpg'</span>;<span class="string">'*.eps'</span>;<span class="string">'*.fig'</span>};
1362             [filename, pathname] = uiputfile( filter,<span class="string">'Save figure as:'</span>);
1363             
1364             filename = strcat(char(pathname), char(filename));
1365             <span class="keyword">end</span>
1366             
1367             saveas(gcf,fullfile( output_dir, <span class="string">'screen_withdesign.fig'</span>));
1368             saveas(gcf,fullfile( output_dir, <span class="string">'screen_withdesign.png'</span>));
1369             
1370            
1371             set( handles.showDesign,<span class="string">'Value'</span>, 0);
1372             <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>( hObject, eventdata, handles);
1373             
1374             saveas(gcf,fullfile( output_dir, <span class="string">'screen.fig'</span>));
1375             saveas(gcf,fullfile( output_dir, <span class="string">'screen.png'</span>));
1376             
1377             
1378         <span class="keyword">case</span> 4, <span class="comment">% save SPM regressors</span>
1379             <a href="#_sub14" class="code" title="subfunction savefile_Callback_SaveRegressor(handles)">savefile_Callback_SaveRegressor</a>(handles);
1380             
1381         <span class="keyword">case</span> {5,6,7}, <span class="comment">% save mask</span>
1382             <a href="#_sub15" class="code" title="subfunction savefile_Callback_SaveMask(handles,option)">savefile_Callback_SaveMask</a>(handles,s-4);
1383     <span class="keyword">end</span>
1384 <span class="keyword">end</span>
1385 
1386 cd(tmpdir);
1387 <span class="keyword">end</span>
1388 
1389 <span class="comment">% -----------------------------------------------------------------------</span>
1390 <span class="comment">% SAVEFILE_CALLBACK_SAVEREGRESSORS</span>
1391 <span class="comment">% saves SPM regressor files</span>
1392 <span class="comment">% One regressor file per session, named art_regression_outliers_*.mat, and</span>
1393 <span class="comment">% stored in the original location of each functional series (or if not</span>
1394 <span class="comment">% possible to current directory)</span>
1395 <span class="comment">% Regressor matrices contains 1's at the location of each outlier. This</span>
1396 <span class="comment">% implements outlier removal in SPM when these regressor files are used as</span>
1397 <span class="comment">% covariates</span>
1398 <span class="comment">% -----------------------------------------------------------------------</span>
1399 <a name="_sub14" href="#_subfunctions" class="code">function savefile_Callback_SaveRegressor(handles)</a>
1400 g = getappdata(handles.zthresh,<span class="string">'g'</span>);
1401 M = getappdata(handles.savefile,<span class="string">'mv_data_raw'</span>);
1402 mv_data = getappdata(handles.mvthresh,<span class="string">'mv_data'</span>);
1403 num_sess = length(g);
1404 out_idx = round(str2num(get(handles.all_outliers, <span class="string">'String'</span>)));
1405 datafiles=getappdata(handles.savefile,<span class="string">'datafiles'</span>);
1406 
1407 mvthresh = get(handles.mvthresh,<span class="string">'String'</span>);
1408 zthresh = get(handles.zthresh,<span class="string">'String'</span>);
1409 
1410 cur_idx=0;
1411 <span class="keyword">for</span> j=1:num_sess,
1412     idx=<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(out_idx&gt;cur_idx&amp;out_idx&lt;=cur_idx+size(g{j},1));
1413     R1=zeros(size(g{j},1),length(idx));
1414     R1(out_idx(idx)-cur_idx,:)=eye(length(idx));
1415     R2=cat(2,R1,M{j});
1416     R2=cat(2,R2,mv_data(cur_idx+(1:size(g{j},1)),32));
1417     [datafiles_path,datafiles_name] = fileparts(datafiles{j});
1418     disp([<span class="string">'Saving SPM regressor file '</span>,fullfile(datafiles_path,[<span class="string">'art_regression_outliers_'</span>,datafiles_name,<span class="string">'.mat'</span>]),<span class="string">' and '</span>,fullfile(datafiles_path,[<span class="string">'art_regression_outliers_and_movement_'</span>,datafiles_name,<span class="string">'.mat'</span>])]);
1419     <span class="keyword">try</span>
1420         R=R1;save(fullfile(datafiles_path,[<span class="string">'art_regression_outliers_'</span>,datafiles_name,<span class="string">'_'</span>, mvthresh, <span class="string">'_'</span>, zthresh,<span class="string">'.mat'</span>]),<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1421         R=R2;save(fullfile(datafiles_path,[<span class="string">'art_regression_outliers_and_movement_'</span>,datafiles_name,<span class="string">'_'</span>, mvthresh, <span class="string">'_'</span>, zthresh,<span class="string">'.mat'</span>]),<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1422     <span class="keyword">catch</span>
1423         <span class="keyword">try</span>
1424             tdatafiles_path=datafiles_path; tdatafiles_path(tdatafiles_path==filesep)=<span class="string">'_'</span>;
1425             R=R1;save(fullfile(<span class="string">'./'</span>,[tdatafiles_path,<span class="string">'_art_regression_outliers_'</span>,datafiles_name,<span class="string">'.mat'</span>]),<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1426             R=R2;save(fullfile(<span class="string">'./'</span>,[tdatafiles_path,<span class="string">'_art_regression_outliers_and_movement_'</span>,datafiles_name,<span class="string">'.mat'</span>]),<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1427         <span class="keyword">catch</span>
1428             [filename, pathname] =uiputfile({<span class="string">'*.mat'</span>},[<span class="string">'Save session '</span>,num2str(j),<span class="string">' regressor:'</span>],fullfile(datafiles_path,[<span class="string">'art_regression_outliers_'</span>,datafiles_name,<span class="string">'.mat'</span>]));
1429             filename = fullfile(char(pathname), char(filename));
1430             R=R1;save(filename ,<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1431             [filename, pathname] =uiputfile({<span class="string">'*.mat'</span>},[<span class="string">'Save session '</span>,num2str(j),<span class="string">' regressor:'</span>],fullfile(datafiles_path,[<span class="string">'art_regression_outliers_and_movement_'</span>,datafiles_name,<span class="string">'.mat'</span>]));
1432             filename = fullfile(char(pathname), char(filename));
1433             R=R2;save(filename ,<span class="string">'R'</span>,<span class="string">'-mat'</span>); <span class="comment">%#ok&lt;NASGU&gt;</span>
1434         <span class="keyword">end</span>
1435     <span class="keyword">end</span>
1436     
1437     cur_idx=cur_idx+size(g{j},1);
1438 <span class="keyword">end</span>
1439 <span class="keyword">end</span>
1440 
1441 <span class="comment">% -----------------------------------------------------------------------</span>
1442 <span class="comment">% SAVEFILE_CALLBACK_SAVEMASK</span>
1443 <span class="comment">% saves Analysis mask after disregarding outlier scans.</span>
1444 <span class="comment">% Filename 'art_mask.img' saved to current directory or location specified</span>
1445 <span class="comment">% by 'output_dir' field in .cfg file</span>
1446 <span class="comment">% -----------------------------------------------------------------------</span>
1447 <a name="_sub15" href="#_subfunctions" class="code">function savefile_Callback_SaveMask(handles,option)</a>
1448 <span class="keyword">if</span> nargin&lt;2, option=1; <span class="keyword">end</span>
1449 output_dir=getappdata(handles.savefile,<span class="string">'dir'</span>);
1450 
1451 art_mask_temporalfile=getappdata(handles.savefile,<span class="string">'art_mask_temporalfile'</span>);
1452 plotdata=load(fullfile(output_dir,art_mask_temporalfile));<span class="comment">%,'maskscan','VY1','VY','notcoregistered','xyz','Data_Sum','Data_SumSquared');</span>
1453 out_idx=round(str2num(get(handles.all_outliers, <span class="string">'String'</span>)));
1454 <span class="comment">% computes Analysis Mask</span>
1455 Mask=ones(plotdata.VY1.dim);
1456 <span class="keyword">for</span> n1=setdiff(1:length(plotdata.maskscan),out_idx),Mask(plotdata.maskscan{n1})=0;<span class="keyword">end</span>
1457 <span class="keyword">if</span> option&gt;1
1458     <span class="comment">% computes Var/SNR</span>
1459     <span class="keyword">if</span> numel(out_idx)&gt;100, hw=waitbar(0,<span class="string">'updating Variance/SNR plots. Please wait'</span>); <span class="keyword">end</span>
1460     N=numel(plotdata.VY);
1461     Data_Sum=plotdata.Data_Sum;
1462     Data_SumSquared=plotdata.Data_SumSquared;
1463     <span class="keyword">for</span> n1=1:numel(out_idx),
1464         i=out_idx(n1);
1465         <span class="keyword">if</span> plotdata.notcoregistered, temp=spm_get_data(plotdata.VY(i),pinv(plotdata.VY(i).mat)*plotdata.xyz);
1466         <span class="keyword">else</span> temp=reshape(spm_get_data(plotdata.VY(i),plotdata.xyz_voxel),plotdata.VY(i).dim); <span class="keyword">end</span> <span class="comment">%temp=spm_read_vols(plotdata.VY(i)); end</span>
1467         Data_Sum=Data_Sum-temp;
1468         Data_SumSquared=Data_SumSquared-temp.^2;
1469         <span class="keyword">if</span> numel(out_idx)&gt;100, waitbar(n1/numel(out_idx),hw); <span class="keyword">end</span>
1470     <span class="keyword">end</span>
1471     Data_Sum=Data_Sum/max(eps,N-numel(out_idx));
1472     Data_SumSquared=Data_SumSquared/max(eps,N-numel(out_idx));
1473     Data_Std=reshape(sqrt(max(0,Data_SumSquared-Data_Sum.^2)),plotdata.VY1.dim)*(N-numel(out_idx))/max(eps,N-numel(out_idx)-1);
1474     Data_SNR=Data_Sum./max(eps,Data_Std);
1475     <span class="keyword">if</span> numel(out_idx)&gt;100, close(hw); <span class="keyword">end</span>
1476 <span class="keyword">end</span>
1477 <span class="keyword">for</span> noption=1:numel(option)
1478     <span class="keyword">switch</span> option(noption)
1479         <span class="keyword">case</span> 1, b=Mask; filename=<span class="string">'art_mask.img'</span>; filetype=<span class="string">'uint8'</span>; filedescription=<span class="string">'analysis mask'</span>;
1480         <span class="keyword">case</span> 2, b=Mask.*Data_Std; filename=<span class="string">'art_ResStd.img'</span>; filetype=<span class="string">'float32'</span>; filedescription=<span class="string">'Voxel-wise variability'</span>;
1481         <span class="keyword">case</span> 3, b=Mask.*Data_SNR; filename=<span class="string">'art_SNR.img'</span>; filetype=<span class="string">'float32'</span>; filedescription=<span class="string">'Voxel-wise SNR'</span>;
1482     <span class="keyword">end</span>
1483     V=plotdata.VY1;
1484     V.fname=fullfile(output_dir,filename);
1485     V.descrip=filedescription;
1486     V.dt=[spm_type(filetype) spm_platform(<span class="string">'bigend'</span>)];
1487     spm_write_vol(V,b);
1488     disp([<span class="string">'New '</span>,filedescription,<span class="string">' file saved to '</span>,V.fname]);
1489 <span class="keyword">end</span>
1490 <span class="keyword">end</span>
1491 
1492 <span class="comment">% -----------------------------------------------------------------------</span>
1493 <span class="comment">% READ_ART_SESS_FILE</span>
1494 <span class="comment">% reads a .cfg file (art session file) defining the art processing options</span>
1495 <span class="comment">% ohinds 2008-04-23</span>
1496 <span class="comment">% -----------------------------------------------------------------------</span>
1497 <a name="_sub16" href="#_subfunctions" class="code">function [num_sess,global_type_flag,drop_flag,motionFileType,motion_threshold,global_threshold,use_diff_motion,use_diff_global,use_norms,SPMfile,mask_file,output_dir,P,M] = read_art_sess_file(sess_file)</a>
1498 
1499 <span class="keyword">if</span> ~exist(sess_file,<span class="string">'file'</span>)
1500     error([<span class="string">'session file '</span> sess_file <span class="string">' cant be opened'</span>]);
1501 <span class="keyword">end</span>
1502 
1503 num_sess = 1;
1504 global_type_flag = 1;
1505 drop_flag = 0;
1506 motionFileType = 0;
1507 image_dir = <span class="string">''</span>; 
1508 motion_dir = <span class="string">''</span>;
1509 auto_motion_fname = 0;
1510 motion_threshold=[];
1511 global_threshold=[];
1512 use_diff_motion=1;
1513 use_diff_global=1;
1514 use_norms=1;
1515 SPMfile=[];
1516 mask_file=[];
1517 output_dir=<span class="string">''</span>;
1518 
1519 fp = fopen(sess_file);
1520 
1521 <span class="comment">% read each param</span>
1522 s = fscanf(fp,<span class="string">'%s'</span>,1);
1523 <span class="keyword">while</span>(~strcmp(s,<span class="string">'end'</span>))
1524     <span class="keyword">if</span> ~isempty(s) &amp;&amp; s(1) == <span class="string">'#'</span>
1525         <span class="comment">% skips until end of line</span>
1526         fgetl(fp);
1527     <span class="keyword">elseif</span> strcmp(s,<span class="string">'sessions:'</span>)
1528         <span class="comment">% num_sessions</span>
1529         num_sess = fscanf(fp,<span class="string">'%d'</span>,1);
1530     <span class="keyword">elseif</span> strcmp(s,<span class="string">'global_mean:'</span>)
1531         <span class="comment">% global_type_flag</span>
1532         global_type_flag = fscanf(fp,<span class="string">'%d'</span>,1);
1533     <span class="keyword">elseif</span> strcmp(s,<span class="string">'drop_flag:'</span>)
1534         <span class="comment">% drop_flag</span>
1535         drop_flag = fscanf(fp,<span class="string">'%d'</span>,1);
1536     <span class="keyword">elseif</span> strcmp(s,<span class="string">'motion_file_type:'</span>)
1537         motionFileType = fscanf(fp,<span class="string">'%d'</span>,1);
1538     <span class="keyword">elseif</span> strcmp(s,<span class="string">'image_dir:'</span>)
1539         image_dir = fscanf(fp,<span class="string">'%s'</span>,1);
1540     <span class="keyword">elseif</span> strcmp(s,<span class="string">'motion_dir:'</span>)
1541         motion_dir = fscanf(fp,<span class="string">'%s'</span>,1);
1542     <span class="keyword">elseif</span> strcmp(s,<span class="string">'motion_fname_from_image_fname:'</span>)
1543         auto_motion_fname = str2num(fscanf(fp,<span class="string">'%s'</span>,1));
1544     <span class="keyword">elseif</span> strcmp(s,<span class="string">'motion_threshold:'</span>)
1545         motion_threshold = fscanf(fp,<span class="string">'%f'</span>,1);
1546     <span class="keyword">elseif</span> strcmp(s,<span class="string">'global_threshold:'</span>)
1547         global_threshold = fscanf(fp,<span class="string">'%f'</span>,1);
1548     <span class="keyword">elseif</span> strcmp(s,<span class="string">'spm_file:'</span>)
1549         SPMfile = fscanf(fp,<span class="string">'%s'</span>,1);
1550     <span class="keyword">elseif</span> strcmp(s,<span class="string">'use_diff_motion:'</span>)
1551         use_diff_motion = fscanf(fp,<span class="string">'%d'</span>,1);
1552     <span class="keyword">elseif</span> strcmp(s,<span class="string">'use_diff_global:'</span>)
1553         use_diff_global = fscanf(fp,<span class="string">'%d'</span>,1);
1554     <span class="keyword">elseif</span> strcmp(s,<span class="string">'use_norms:'</span>)
1555         use_norms = fscanf(fp,<span class="string">'%d'</span>,1);
1556     <span class="keyword">elseif</span> strcmp(s,<span class="string">'mask_file:'</span>)
1557         mask_file = fscanf(fp,<span class="string">'%s'</span>,1);
1558     <span class="keyword">elseif</span> strcmp(s,<span class="string">'output_dir:'</span>)
1559         output_dir = <a href="#_sub44" class="code" title="subfunction filename=art_fullfile(varargin)">art_fullfile</a>(fscanf(fp,<span class="string">'%s'</span>,1));
1560     <span class="keyword">end</span>
1561     s = fscanf(fp,<span class="string">'%s'</span>,1);
1562 <span class="keyword">end</span>
1563 
1564 M = {};
1565 P = {};
1566 <span class="comment">% read the filenames</span>
1567 s = fscanf(fp,<span class="string">'%s'</span>,1);
1568 <span class="keyword">while</span>(~strcmp(s,<span class="string">'end'</span>))
1569     <span class="keyword">if</span> strcmp(s,<span class="string">'session'</span>)
1570         sess = fscanf(fp,<span class="string">'%d'</span>,1);
1571         type = fscanf(fp,<span class="string">'%s'</span>,1);
1572         
1573         
1574         <span class="comment">% set up P</span>
1575         <span class="keyword">if</span> size(P,2) &lt; sess
1576             P{sess} = {}; <span class="comment">%#ok&lt;AGROW&gt;</span>
1577         <span class="keyword">end</span>
1578     <span class="keyword">elseif</span> numel(s)&gt;0&amp;&amp;s(1) == <span class="string">'#'</span>
1579         <span class="comment">% skips until end of line</span>
1580         fgetl(fp);
1581     <span class="keyword">elseif</span> strcmp(type,<span class="string">'image'</span>)
1582         <span class="keyword">if</span> any(s==<span class="string">'?'</span>),
1583             idx=<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(s==<span class="string">'?'</span>);
1584             ns=length(idx);
1585             <span class="keyword">for</span> sn=0:10^ns-1,
1586                 st=s;st(idx)=num2str(sn,[<span class="string">'%0'</span>,num2str(ns),<span class="string">'d'</span>]);
1587                 <span class="keyword">if</span> ~isempty(dir(fullfile(image_dir,st))),
1588                     P{sess}{end+1} = fullfile(image_dir,st); <span class="comment">%#ok&lt;AGROW&gt;</span>
1589                 <span class="keyword">end</span>
1590             <span class="keyword">end</span>
1591             s(idx)=num2str(1,[<span class="string">'%0'</span>,num2str(ns),<span class="string">'d'</span>]);
1592         <span class="keyword">else</span>
1593             P{sess}{end+1} = fullfile(image_dir,s); <span class="comment">%#ok&lt;AGROW&gt;</span>
1594         <span class="keyword">end</span>
1595         
1596         <span class="keyword">if</span> auto_motion_fname &amp;&amp; length(P{sess})&lt;=1
1597             tmotion_dir=image_dir;
1598             <span class="keyword">if</span> motionFileType == 2
1599                 M{sess} = <a href="#_sub36" class="code" title="subfunction mp = read_siemens_motion_parm_file(fname)">read_siemens_motion_parm_file</a>(<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(<span class="string">''</span>,fullfile(tmotion_dir,s),<span class="string">'.txt'</span>)); <span class="comment">%#ok&lt;AGROW&gt;</span>
1600             <span class="keyword">elseif</span> motionFileType == 0
1601                 M{sess}=[]; <span class="comment">%#ok&lt;AGROW&gt;</span>
1602                 <span class="keyword">for</span> n1=0:5,
1603                     <span class="keyword">if</span> ~isempty(dir(<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(<span class="string">'rp_'</span>,<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(-n1,fullfile(tmotion_dir,s)),<span class="string">'.txt'</span>))),
1604                         M{sess} = load(<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(<span class="string">'rp_'</span>,<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(-n1,fullfile(tmotion_dir,s)),<span class="string">'.txt'</span>)); <span class="comment">%#ok&lt;AGROW&gt;</span>
1605                         <span class="keyword">break</span>;
1606                     <span class="keyword">end</span>
1607                 <span class="keyword">end</span>
1608                 <span class="keyword">if</span> isempty(M{sess}),error([<span class="string">'No motion file found: '</span>,<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(<span class="string">'rp_'</span>,fullfile(tmotion_dir,s),<span class="string">'.txt'</span>),<span class="string">' or similar'</span>]); <span class="keyword">end</span>
1609             <span class="keyword">elseif</span> motionFileType == 1
1610                 M{sess} = load(<a href="#_sub40" class="code" title="subfunction fileout=strprepend(str1,file,str2)">strprepend</a>(<span class="string">''</span>,fullfile(tmotion_dir,s),<span class="string">'.par'</span>)); <span class="comment">%#ok&lt;AGROW&gt;</span>
1611             <span class="keyword">end</span>
1612         <span class="keyword">end</span>
1613         
1614     <span class="keyword">elseif</span> strcmp(type,<span class="string">'movement'</span>) || strcmp(type,<span class="string">'motion'</span>)
1615         <span class="keyword">if</span> motionFileType == 2
1616             M{sess} = <a href="#_sub36" class="code" title="subfunction mp = read_siemens_motion_parm_file(fname)">read_siemens_motion_parm_file</a>(fullfile(motion_dir,s)); <span class="comment">%#ok&lt;AGROW&gt;</span>
1617         <span class="keyword">else</span>
1618             M{sess} = load(fullfile(motion_dir,s)); <span class="comment">%#ok&lt;AGROW&gt;</span>
1619         <span class="keyword">end</span>
1620     <span class="keyword">end</span>
1621     s = fscanf(fp,<span class="string">'%s'</span>,1);
1622 <span class="keyword">end</span>
1623 
1624 <span class="keyword">for</span> i=1:numel(P)
1625     P{i} = char(P{i}); <span class="comment">%#ok&lt;AGROW&gt; %make_spm_file_matrix(P{i});</span>
1626 <span class="keyword">end</span>
1627 
1628 fclose(fp);
1629 <span class="keyword">end</span>
1630 
1631 
1632 
1633 <span class="comment">%% ---------------   Other GUI functions -------------------------------</span>
1634 <span class="comment">% The following functions handle simple gui callback events</span>
1635 <span class="comment">% ----------------------------------------------------------------------</span>
1636 
1637 <span class="comment">% --- Executes on button press in z_up.</span>
1638 <a name="_sub17" href="#_subfunctions" class="code">function z_up_Callback(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;*DEFNU&gt;</span>
1639 <a href="#_sub2" class="code" title="subfunction UpdateGlobal(hObject, eventdata, handles, incr) ">UpdateGlobal</a>(hObject, eventdata, handles, 1.05);
1640 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles)
1641 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1642 <span class="keyword">end</span>
1643 
1644 <span class="comment">% --- Executes on button press in z_down.</span>
1645 <a name="_sub18" href="#_subfunctions" class="code">function z_down_Callback(hObject, eventdata, handles)</a>
1646 <a href="#_sub2" class="code" title="subfunction UpdateGlobal(hObject, eventdata, handles, incr) ">UpdateGlobal</a>(hObject, eventdata, handles,0.95);
1647 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1648 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1649 <span class="keyword">end</span>
1650 
1651 <span class="comment">% --- Executes on zthreshold.</span>
1652 <a name="_sub19" href="#_subfunctions" class="code">function zthresh_Callback(hObject, eventdata, handles)</a>
1653 <a href="#_sub2" class="code" title="subfunction UpdateGlobal(hObject, eventdata, handles, incr) ">UpdateGlobal</a>(hObject, eventdata, handles,1.0);
1654 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1655 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1656 <span class="keyword">end</span>
1657 
1658 <span class="comment">% --- Executes on button press in mv_up.</span>
1659 <a name="_sub20" href="#_subfunctions" class="code">function mv_up_Callback(hObject, eventdata, handles)</a>
1660 <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,1.05);
1661 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1662 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1663 <span class="keyword">end</span>
1664 
1665 <span class="comment">% --- Executes on button press in mv_down.</span>
1666 <a name="_sub21" href="#_subfunctions" class="code">function mv_down_Callback(hObject, eventdata, handles)</a>
1667 <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,0.95);
1668 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1669 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1670 <span class="keyword">end</span>
1671 
1672 <span class="comment">% --- Executes on update of mvthresh.</span>
1673 <a name="_sub22" href="#_subfunctions" class="code">function mvthresh_Callback(hObject, eventdata, handles)</a>
1674 <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,1.0);
1675 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1676 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1677 <span class="keyword">end</span>
1678 
1679 <span class="comment">% --- Executes on button press in rt_up.</span>
1680 <a name="_sub23" href="#_subfunctions" class="code">function rt_up_Callback(hObject, eventdata, handles)</a>
1681 <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,1.05)
1682 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1683 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1684 <span class="keyword">end</span>
1685 
1686 <span class="comment">% --- Executes on button press in rt_down.</span>
1687 <a name="_sub24" href="#_subfunctions" class="code">function rt_down_Callback(hObject, eventdata, handles)</a>
1688 <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,0.95)
1689 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1690 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1691 <span class="keyword">end</span>
1692 
1693 <span class="comment">% --- Executes on update of mvthresh.</span>
1694 <a name="_sub25" href="#_subfunctions" class="code">function rtthresh_Callback(hObject, eventdata, handles)</a>
1695 <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,1.0)
1696 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1697 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1698 <span class="keyword">end</span>
1699 
1700 <span class="comment">% --- Executes when comp motion checkbox is changed</span>
1701 <a name="_sub26" href="#_subfunctions" class="code">function norms_Callback(hObject, eventdata, handles)</a>
1702 <a href="#_sub3" class="code" title="subfunction UpdateMovement(hObject, eventdata, handles, incr) ">UpdateMovement</a>(hObject, eventdata, handles,1.0);
1703 <a href="#_sub4" class="code" title="subfunction UpdateRotation(hObject, eventdata, handles, incr) ">UpdateRotation</a>(hObject, eventdata, handles,1.0);
1704 <a href="#_sub6" class="code" title="subfunction UnionOutliers(hObject, eventdata, handles) ">UnionOutliers</a>(hObject, eventdata, handles);
1705 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1706 <span class="keyword">end</span>
1707 
1708 <span class="comment">% --- Executes when editing the all_outliers list</span>
1709 <a name="_sub27" href="#_subfunctions" class="code">function all_outliers_Callback(hObject, eventdata, handles)</a>
1710 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles);
1711 <span class="keyword">end</span>
1712 
1713 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1714 <a name="_sub28" href="#_subfunctions" class="code">function all_outliers_CreateFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1715 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1716     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1717 <span class="keyword">end</span>
1718 <span class="keyword">end</span>
1719 
1720 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
1721 <a name="_sub29" href="#_subfunctions" class="code">function varargout = art_OutputFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSL&gt;</span>
1722 varargout{1} = handles.output;
1723 <span class="keyword">end</span>
1724 
1725 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1726 <a name="_sub30" href="#_subfunctions" class="code">function zthresh_CreateFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1727 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1728     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1729 <span class="keyword">end</span>
1730 <span class="keyword">end</span>
1731 
1732 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1733 <a name="_sub31" href="#_subfunctions" class="code">function mvthresh_CreateFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1734 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1735     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1736 <span class="keyword">end</span>
1737 <span class="keyword">end</span>
1738 
1739 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1740 <a name="_sub32" href="#_subfunctions" class="code">function rtthresh_CreateFcn(hObject, eventdata, handles) </a><span class="comment">%#ok&lt;INUSD&gt;</span>
1741 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1742     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1743 <span class="keyword">end</span>
1744 <span class="keyword">end</span>
1745 
1746 <span class="comment">% --- Executes when show design checkbox is changed</span>
1747 <a name="_sub33" href="#_subfunctions" class="code">function showDesign_Callback(hObject, eventdata, handles)</a>
1748 <a href="#_sub5" class="code" title="subfunction UpdateSummaryplot(hObject, eventdata, handles)">UpdateSummaryplot</a>(hObject, eventdata, handles)
1749 <span class="keyword">end</span>
1750 
1751 
1752 <span class="comment">%% ---------------   Utility functions -------------------------------</span>
1753 <span class="comment">% General utility functions (not specific to ART)</span>
1754 <span class="comment">% --------------------------------------------------------------------</span>
1755 
1756 <span class="comment">% -----------------------------------------------------------------------</span>
1757 <span class="comment">% ART_MASKGLOBAL_SCAN</span>
1758 <span class="comment">% Computes the analysis mask for a single volume</span>
1759 <span class="comment">% -----------------------------------------------------------------------</span>
1760 <a name="_sub34" href="#_subfunctions" class="code">function [idxremove_analysis,idxremove_globalsignal]=art_maskglobal_scan(data,VYi,VY1,VY1inv)</a>
1761 data1=data&gt;mean(data(~isnan(data)))/8; <span class="comment">% global-signal mask</span>
1762 idxremove_globalsignal=<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(data1~=true);
1763 data=(data&gt;0.80*mean(data(data1&gt;0))); <span class="comment">% analysis mask</span>
1764 idxremove_analysis=<a href="../../../components/+utils/find.html" class="code" title="function [ output ] = find( dirdata, pattern, type, depth )">find</a>(data~=true);
1765 <span class="keyword">if</span> any(any(VYi.mat~=VY1.mat)), <span class="comment">% resample global-signal and analysis mask voxels to VY1 space</span>
1766     [tempx,tempy,tempz]=ind2sub(VYi.dim(1:3),idxremove_analysis);
1767     xyz=round(VY1inv*VYi.mat*[tempx(:),tempy(:),tempz(:),ones(numel(tempx),1)]');
1768     idxremove_analysis=sub2ind(VY1.dim(1:3),max(1,min(VY1.dim(1),xyz(1,:))),max(1,min(VY1.dim(2),xyz(2,:))),max(1,min(VY1.dim(3),xyz(3,:))));
1769     [tempx,tempy,tempz]=ind2sub(VYi.dim(1:3),idxremove_globalsignal);
1770     xyz=round(VY1inv*VYi.mat*[tempx(:),tempy(:),tempz(:),ones(numel(tempx),1)]');
1771     idxremove_globalsignal=sub2ind(VY1.dim(1:3),max(1,min(VY1.dim(1),xyz(1,:))),max(1,min(VY1.dim(2),xyz(2,:))),max(1,min(VY1.dim(3),xyz(3,:))));
1772 <span class="keyword">end</span>
1773 idxremove_analysis=uint32(idxremove_analysis(:));
1774 idxremove_globalsignal=uint32(idxremove_globalsignal(:));
1775 <span class="keyword">end</span>
1776 
1777 <span class="comment">% -----------------------------------------------------------------------</span>
1778 <span class="comment">% GET_DESIGN</span>
1779 <span class="comment">% Imports SPM design matrix information from SPM.mat file</span>
1780 <span class="comment">% -----------------------------------------------------------------------</span>
1781 <a name="_sub35" href="#_subfunctions" class="code">function [SPM,design,names] = get_design(handles)</a>
1782 SPM = getappdata(handles.showDesign,<span class="string">'SPM'</span>);
1783 SPMbak=SPM;
1784 <span class="keyword">if</span> (isempty(SPM))
1785     spm_ver = spm(<span class="string">'ver'</span>);
1786     <span class="keyword">switch</span>(spm_ver),
1787         <span class="keyword">case</span> <span class="string">'SPM99'</span>, spm_ver=1;
1788         <span class="keyword">case</span> <span class="string">'SPM2'</span>, spm_ver=2;
1789         <span class="keyword">case</span> <span class="string">'SPM5'</span>, spm_ver=5;
1790         <span class="keyword">case</span> {<span class="string">'SPM8b'</span>,<span class="string">'SPM8'</span>}, spm_ver=8;
1791         <span class="keyword">otherwise</span>, disp([<span class="string">'Warning! unrecognized SPM version '</span>,spm_ver]); spm_ver=5;
1792     <span class="keyword">end</span>
1793     <span class="keyword">switch</span> spm_ver
1794         <span class="keyword">case</span> {1,2}
1795             tmpfile = spm_get(1,<span class="string">'.mat'</span>,<span class="string">'Select design matrix:'</span>);
1796         <span class="keyword">case</span> {5,8}
1797             tmpfile = spm_select(1,<span class="string">'^.*\.mat$'</span>,<span class="string">'Select design matrix:'</span>);
1798     <span class="keyword">end</span>
1799     <span class="keyword">if</span> isempty(tmpfile), error(<span class="string">'No design matrix selected'</span>); <span class="keyword">end</span>
1800     load(tmpfile);
1801     setappdata(handles.showDesign,<span class="string">'SPMfile'</span>,tmpfile);
1802     setappdata(handles.showDesign,<span class="string">'SPM'</span>,SPM);
1803 <span class="keyword">end</span>
1804 sessions = getappdata(handles.showDesign,<span class="string">'sessions'</span>);
1805 <span class="keyword">if</span> isempty(sessions)||any(sessions&lt;0),
1806     <span class="keyword">if</span> length(sessions)==length(SPM.Sess) &amp;&amp; all(sessions==-(1:length(sessions))),
1807         sessions = abs(sessions);
1808     <span class="keyword">elseif</span> numel(SPM.Sess)&lt;numel(sessions)
1809         setappdata(handles.showDesign,<span class="string">'SPM'</span>,SPMbak);
1810         error(<span class="string">'Incorrect number of sessions in SPM.mat file'</span>);
1811     <span class="keyword">else</span>
1812         tmpsess = inputdlg(<span class="string">'What session(s) to use? (e.g. 1 or [1,2])'</span>,<span class="string">''</span>,1,{[<span class="string">'['</span>,num2str(abs(sessions)),<span class="string">']'</span>]});
1813         sessions = eval(char(tmpsess));
1814     <span class="keyword">end</span>
1815     setappdata(handles.showDesign,<span class="string">'sessions'</span>,sessions);
1816 <span class="keyword">end</span>
1817 rows = [];
1818 cols = [];
1819 names={};
1820 <span class="keyword">for</span> s = sessions
1821     rows = [rows SPM.Sess(s).row]; <span class="comment">%#ok&lt;AGROW&gt;</span>
1822     cols = [cols SPM.Sess(s).col(1:length(SPM.Sess(s).U))]; <span class="comment">%#ok&lt;AGROW&gt; % extracts only effects of interest (no covariates) from design matrix</span>
1823     names=cat(1,names,SPM.Sess(s).U(:).name);
1824 <span class="keyword">end</span>
1825 
1826 design = SPM.xX.X(rows,cols);
1827 <span class="keyword">end</span>
1828 
1829 <span class="comment">% -----------------------------------------------------------------------</span>
1830 <span class="comment">% READ_SIEMENS_MOTION_PARM_FILE</span>
1831 <span class="comment">% reads a siemens motion detection parameter file</span>
1832 <span class="comment">% Oliver Hinds &lt;ohinds@mit.edu&gt;</span>
1833 <span class="comment">% 2007-07-23</span>
1834 <span class="comment">% -----------------------------------------------------------------------</span>
1835 <a name="_sub36" href="#_subfunctions" class="code">function mp = read_siemens_motion_parm_file(fname)</a>
1836 
1837 mp = [];
1838 <span class="comment">% open the file</span>
1839 fp = fopen(fname);
1840 <span class="keyword">if</span> fp == -1
1841     error(<span class="string">'coulnd''t open motion parm file.'</span>);
1842 <span class="keyword">end</span>
1843 
1844 <span class="comment">% read each parameter</span>
1845 i = 1;
1846 <span class="keyword">while</span>(~feof(fp))
1847     <span class="comment">% read the motion header</span>
1848     fscanf(fp,<span class="string">'%s'</span>,6);    
1849     <span class="keyword">if</span> feof(fp)
1850         <span class="keyword">break</span>;
1851     <span class="keyword">end</span>    
1852     <span class="keyword">if</span> i == 1
1853         fscanf(fp,<span class="string">'%s'</span>,5);
1854     <span class="keyword">end</span>    
1855     fscanf(fp,<span class="string">'%s'</span>,7);
1856     <span class="keyword">for</span> j=1:6
1857         fscanf(fp,<span class="string">'%s'</span>,4);
1858         mp(i,j) = fscanf(fp,<span class="string">'%f'</span>,1); <span class="comment">%#ok&lt;AGROW&gt;</span>
1859     <span class="keyword">end</span>    
1860     fscanf(fp,<span class="string">'%s'</span>,1);
1861     i=i+1;
1862 <span class="keyword">end</span>
1863 
1864 <span class="comment">% siemens keeps their params in a different order than spm does, and their rotations in degrees. fix it</span>
1865 m = mp;
1866 mp(:,4:6) = m(:,4:6)*pi/180;
1867 mp(:,1)   = m(:,2);
1868 mp(:,2)   = m(:,1);
1869 mp(:,3)   =-m(:,3);
1870 <span class="keyword">end</span>
1871 
1872 <span class="comment">% -----------------------------------------------------------------------</span>
1873 <span class="comment">% MAKE_SPM_FILE_MATRIX</span>
1874 <span class="comment">% Take a cell array and pad appropritately to make a matrix</span>
1875 <span class="comment">% -----------------------------------------------------------------------</span>
1876 <a name="_sub37" href="#_subfunctions" class="code">function m = make_spm_file_matrix(p)</a>
1877 
1878 mx = -1;
1879 <span class="keyword">for</span> i=1:numel(p)
1880     <span class="keyword">if</span> size(p{i},2) &gt; mx
1881         mx = size(p{i},2);
1882     <span class="keyword">end</span>
1883 <span class="keyword">end</span>
1884 
1885 m = char(32*ones(numel(p),mx));
1886 <span class="keyword">for</span> i=1:numel(p)
1887     m(i,mx-length(p{i})+1:end) = p{i};
1888 <span class="keyword">end</span>
1889 <span class="keyword">end</span>
1890 
1891 <span class="comment">% -----------------------------------------------------------------------</span>
1892 <span class="comment">% ZSCORE</span>
1893 <span class="comment">% Computes standardized z-scores</span>
1894 <span class="comment">% -----------------------------------------------------------------------</span>
1895 <a name="_sub38" href="#_subfunctions" class="code">function z = zscore(x)</a>
1896 <span class="comment">%ZSCORE Standardized z score.</span>
1897 <span class="comment">% z=zscore(x);</span>
1898 <span class="comment">%</span>
1899 stdx=std(x);stdx(stdx==0)=1;
1900 z=(x-mean(x))./stdx;
1901 <span class="keyword">end</span>
1902 
1903 <span class="comment">% -----------------------------------------------------------------------</span>
1904 <span class="comment">% RANGE</span>
1905 <span class="comment">% Computes sample range</span>
1906 <span class="comment">% -----------------------------------------------------------------------</span>
1907 <a name="_sub39" href="#_subfunctions" class="code">function d=range(x)</a>
1908 <span class="comment">%RANGE  Sample range.</span>
1909 <span class="comment">%d=range(x);</span>
1910 <span class="comment">%</span>
1911 d=max(x)-min(x);
1912 <span class="keyword">end</span>
1913 
1914 <span class="comment">% -----------------------------------------------------------------------</span>
1915 <span class="comment">% STRPREPEND</span>
1916 <span class="comment">% pre-pend filename with string</span>
1917 <span class="comment">% -----------------------------------------------------------------------</span>
1918 <a name="_sub40" href="#_subfunctions" class="code">function fileout=strprepend(str1,file,str2)</a>
1919 
1920 [fpath,ffile,fext]=fileparts(file);
1921 <span class="keyword">if</span> nargin&lt;3, str2=fext; <span class="keyword">end</span>
1922 <span class="keyword">if</span> ~ischar(str1),ffile=ffile(1+abs(str1):end);str1=<span class="string">''</span>; <span class="keyword">end</span>
1923 <span class="keyword">if</span> ~ischar(str2),ffile=ffile(1:end-abs(str2));str2=<span class="string">''</span>; <span class="keyword">end</span>
1924 fileout=fullfile(fpath,[str1,ffile,str2]);
1925 <span class="keyword">end</span>
1926 
1927 <span class="comment">% -----------------------------------------------------------------------</span>
1928 <span class="comment">% CUMDISP</span>
1929 <span class="comment">% Persistent display</span>
1930 <span class="comment">% -----------------------------------------------------------------------</span>
1931 <a name="_sub41" href="#_subfunctions" class="code">function cumdisp(txt)</a>
1932 <span class="comment">% CUMDISP persistent disp</span>
1933 <span class="comment">% cumdisp; initializes persistent display</span>
1934 <span class="comment">% cumdisp(text); displays persistent text</span>
1935 <span class="comment">%</span>
1936 <span class="keyword">persistent</span> oldtxt;
1937 <span class="keyword">if</span> nargin&lt;1,
1938     oldtxt=<span class="string">''</span>;
1939     fprintf(1,<span class="string">'\n'</span>);
1940 <span class="keyword">else</span>
1941     fprintf(1,[repmat(<span class="string">'\b'</span>,[1,length(oldtxt)]),txt]);
1942     oldtxt=sprintf(txt);
1943 <span class="keyword">end</span>
1944 <span class="keyword">end</span>
1945 
1946 <span class="comment">% -----------------------------------------------------------------------</span>
1947 <span class="comment">% PRCTILE</span>
1948 <span class="comment">% computes smaple percentile</span>
1949 <span class="comment">% -----------------------------------------------------------------------</span>
1950 <a name="_sub42" href="#_subfunctions" class="code">function z=prctile(x,p)</a>
1951 nx=length(x);
1952 z=zeros(size(p));
1953 sx=sort(x);
1954 q = [0,100*(0.5:(nx-0.5))./nx,100]';
1955 xx = [sx(1);sx(:);sx(end)];
1956 z(:) = interp1q(q,xx,p(:));
1957 <span class="keyword">end</span>
1958 
1959 <span class="comment">% -----------------------------------------------------------------------</span>
1960 <span class="comment">% HANNING</span>
1961 <span class="comment">% Outputs Hann window</span>
1962 <span class="comment">% -----------------------------------------------------------------------</span>
1963 <a name="_sub43" href="#_subfunctions" class="code">function w=hanning(n)</a>
1964 
1965 <span class="keyword">if</span> ~rem(n,2),<span class="comment">%even</span>
1966     w = .5*(1 - cos(2*pi*(1:n/2)'/(n+1)));
1967     w=[w;flipud(w)];
1968 <span class="keyword">else</span> <span class="comment">%odd</span>
1969     w = .5*(1 - cos(2*pi*(1:(n+1)/2)'/(n+1)));
1970     w = [w; flipud(w(1:end-1))];
1971 <span class="keyword">end</span>
1972 <span class="keyword">end</span>
1973 
1974 <span class="comment">% -----------------------------------------------------------------------</span>
1975 <span class="comment">% ART_FULLFILE</span>
1976 <span class="comment">% Builds absolute full filename from parts</span>
1977 <span class="comment">% -----------------------------------------------------------------------</span>
1978 <a name="_sub44" href="#_subfunctions" class="code">function filename=art_fullfile(varargin)</a>
1979 
1980 <span class="keyword">if</span> ~nargin, filename=pwd; <span class="keyword">return</span>; 
1981 <span class="keyword">elseif</span> nargin==1, filename=varargin{1}; 
1982 <span class="keyword">else</span> filename=fullfile(varargin{:});
1983 <span class="keyword">end</span>
1984 <span class="keyword">if</span> isempty(filename), filename=pwd; <span class="keyword">return</span>; <span class="keyword">end</span>
1985 [filename_path,filename_name,filename_ext]=fileparts(filename);
1986 <span class="keyword">if</span> isempty(filename_path),
1987     filename_path=pwd;
1988 <span class="keyword">else</span>
1989     cwd=pwd;
1990     cd(filename_path);
1991     filename_path=pwd;
1992     cd(cwd);
1993 <span class="keyword">end</span>
1994 filename=fullfile(filename_path,[filename_name,filename_ext]);
1995 <span class="keyword">end</span>
1996</pre></div>
<hr><address>Generated on Wed 22-Feb-2017 23:31:09 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>